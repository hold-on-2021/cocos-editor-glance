(()=>{"use strict";const e=require("fire-url"),t=require("fire-path"),i=require("fire-fs"),s=require("async");Editor.polymerElement({behaviors:[Editor.UI.PolymerFocusable,Editor.UI.Droppable,Editor.UI.idtree],listeners:{focus:"_onFocus",blur:"_onBlur",mousedown:"_onMouseDown",contextmenu:"_onContextMenu",dragstart:"_onDragStart",dragend:"_onDragEnd","drop-area-move":"_onDropAreaMove","drop-area-enter":"_onDropAreaEnter","drop-area-leave":"_onDropAreaLeave","drop-area-accept":"_onDropAreaAccept","item-selecting":"_onItemSelecting","item-select":"_onItemSelect","item-rename":"_onItemRename","icon-hover-in":"_onIconHoverIn","icon-hover-out":"_onIconHoverOut"},properties:{allowAssign:{type:Boolean,value:!1},copyState:{type:Number,value:1}},ready(){this._shiftStartElement=null,this._conflictElements=[],this.multi=!0,this._initFocusable(this),this._initDroppable(this)},refresh(){this.clear(),this.fire("start-loading",1),Editor.assetdb.deepQuery((e,t)=>{try{this._build(t)}catch(e){Editor.warn(e.message)}this.fire("finish-loading"),this.fire("assets-tree-ready")})},validate:(e,t)=>e.toLowerCase().indexOf(t.toLowerCase())>-1,isScript:e=>"javascript"===e||"coffeescript"===e||"typescript"===e,findUsages(e,t){if(!t)return!0;if(t===e.uuid)return!1;if(!e.destPath)return!1;return i.readFileSync(e.destPath).indexOf(t)>=0},search(e){if(!e)return;let i=[],n="",r="",l=e.split(" ");e="";for(var o=0,a=l.length;o<a;o++){let t=l[o];if(t)if(/^t:.*/.test(t)){let e=t.substring(2).split(",").map(e=>e.trim());i=i.concat(e)}else/^u:.*/.test(t)?n=t.substring(2):/^used:.*/.test(t)?r=t.substring(5):e=t}clearTimeout(this._searchID),this._searchID=null,this.fire("start-loading",100);let h=setTimeout(()=>{this.fire("finish-loading"),h===this._searchID&&Editor.assetdb.queryAssets(null,i,(i,l)=>{if(h!==this._searchID)return;this.clear();let o=e.toLowerCase();n=n.toLowerCase(),r=r.toLowerCase(),s.waterfall([e=>{if(!r||!Editor.Utils.UuidUtils.isUuid(r))return e(),void 0;Editor.assetdb.queryInfoByUuid(r,(t,i)=>{if(t)return e(),void 0;i&&this.isScript(i.type)&&(r=Editor.Utils.UuidUtils.compressUuid(r)),e()})},e=>{l.forEach(e=>{if(e.hidden)return;let i=t.basenameNoExt(e.path),s=t.extname(e.path);if(this.validate(i,o)&&this.validate(e.uuid,n)&&this.findUsages(e,r)){let t=document.createElement("assets-item");this.addItem(this,t,{id:e.uuid,name:i,extname:s,folded:!1,assetType:e.type,isSubAsset:e.isSubAsset,realUrl:e.url,readonly:e.readonly}),t.setIcon(e.type)}}),e()}],()=>{Editor.Selection.curSelection("asset").forEach(e=>{this.selectItemById(e)}),this.activeItemById(Editor.Selection.curActivate("asset"))})})},500);this._searchID=h},rename(e){this.hidePreview();let t=this.getBoundingClientRect(),i=e.getBoundingClientRect(),s=i.top-t.top-1,n=i.left-t.left+27-4;this.$.nameInput.style.top=this.$.content.scrollTop+s+"px",this.$.nameInput.style.left=n+"px",this.$.nameInput.style.width="calc(100% - "+n+"px)",this.$.nameInput.hidden=!1,this.$.nameInput.value=e.name,this.$.nameInput.focus(),this.$.nameInput._renamingEL=e,window.requestAnimationFrame(()=>{this.$.nameInput.select()})},select(e){Editor.Selection.select("asset",e._userId,!0,!0)},clearSelection(){Editor.Selection.clear("asset"),this._activeElement=null,this._shiftStartElement=null},selectAll(){let e=Polymer.dom(this).firstElementChild;if(!e)return;let t=[],i=e,s=e;for(;;){if(!s){if(s=i,s===e)break;i=Polymer.dom(i).parentNode,s=Polymer.dom(s).nextElementSibling}s&&(t.push(s.id),Polymer.dom(s).children.length?(i=s,s=Polymer.dom(s).children[0]):s=Polymer.dom(s).nextElementSibling)}Editor.Selection.select("asset",t,!0,!0)},selectPrev(e){if(!this._activeElement)return;let t=this.prevItem(this._activeElement);if(t&&t!==this._activeElement){if(this.hidePreview(),e){null===this._shiftStartElement&&(this._shiftStartElement=this._activeElement);let e=this._getShiftSelects(t);Editor.Selection.select("asset",e,!0,!0)}else this._shiftStartElement=null,Editor.Selection.select("asset",t._userId,!0,!0);this.activeItem(t),window.requestAnimationFrame(()=>{t.offsetTop<=this.$.content.scrollTop&&(this.$.content.scrollTop=t.offsetTop-2)})}},selectNext(e){if(!this._activeElement)return;let t=this.nextItem(this._activeElement,!1);if(t&&t!==this._activeElement){if(this.hidePreview(),e){null===this._shiftStartElement&&(this._shiftStartElement=this._activeElement);let e=this._getShiftSelects(t);Editor.Selection.select("asset",e,!0,!0)}else this._shiftStartElement=null,Editor.Selection.select("asset",t._userId,!0,!0);this.activeItem(t),window.requestAnimationFrame(()=>{let e=t.$.header.offsetHeight,i=this.offsetHeight-3;t.offsetTop+e>=this.$.content.scrollTop+i&&(this.$.content.scrollTop=t.offsetTop+e-i)})}},getUrl(t){if(t.realUrl)return t.realUrl;let i=t.name+t.extname,s=Polymer.dom(t).parentNode;for(;"ASSETS-ITEM"===s.tagName;)i=e.join(s.name+s.extname,i),s=Polymer.dom(s).parentNode;return i="db://"+i,i},moveItemById(e,t,i){let s=this._id2el[e];if(!s)return Editor.warn("Can not find source element by id: %s",e),void 0;s.name=i,this.setItemParentById(e,t);let n=this._id2el[t];n&&n.foldable&&(n.folded=!1)},addNewItemById(e,t,i){let s=null;if(s=t?this._id2el[t]:this,!s)return;let n=document.createElement("assets-item");this.addItem(s,n,{id:e,name:i.name,extname:i.extname,assetType:i.assetType,isSubAsset:i.isSubAsset,readonly:!!i.readonly}),n.setIcon(i.assetType)},hintItemById(e){let t=this._id2el[e];if(t){if(this._canUseParent(t)){let e=Polymer.dom(t).parentNode;e.folded&&(t=e)}t&&(this.expand(t._userId,!0),this.scrollToItem(t),t.hint())}},showPreviewAfter(e,t){"texture"===e.assetType&&(clearTimeout(this._previewID),this._previewID=setTimeout(()=>{this._previewID=null;let t=Editor.UI.offsetTo(e.$.icon,e.offsetParent).x+e.$.icon.clientWidth-75;t<0&&(t=10),t+150>e.offsetParent.clientWidth&&(t=e.offsetParent.clientWidth-150-10);let i=e.offsetTop-150-10;i-e.offsetParent.scrollTop<0&&(i=e.offsetTop+e.$.bar.offsetHeight+10),this.$.preview.hidden=!1,this.$.preview.style.left=`${t}px`,this.$.preview.style.top=`${i}px`,this.$.preview.style.width="150px",this.$.preview.style.height="150px",this.$.preview.style.backgroundImage=`url("uuid://${e._userId}")`},t))},hidePreview(){clearTimeout(this._previewID),this._previewID=null,this.$.preview.hidden=!0},_build(e){console.time("assets-tree._build()"),e.forEach(e=>{if(!!e.hidden)return;let t;if(t=e.parentUuid?this._id2el[e.parentUuid]:this,!t)return;let i=document.createElement("assets-item");this.addItem(t,i,{id:e.uuid,folded:"mount"!==e.type,name:e.name,extname:e.extname,assetType:e.type,isSubAsset:e.isSubAsset,readonly:e.readonly}),i.setIcon(e.type)}),console.timeEnd("assets-tree._build()")},_getShiftSelects(e){let t=this._shiftStartElement,i=[];if(this._shiftStartElement||(this._shiftStartElement=e),this._shiftStartElement!==e)if(this._shiftStartElement.offsetTop<e.offsetTop)for(;t!==e;)i.push(t._userId),t=this.nextItem(t);else for(;t!==e;)i.push(t._userId),t=this.prevItem(t);return i.push(e._userId),i},_onItemSelecting(e){e.stopPropagation();let t=e.target,i=this._shiftStartElement;if(this._shiftStartElement=null,e.detail.shift){this._shiftStartElement=null===i?this._activeElement:i;let e=this._getShiftSelects(t);Editor.Selection.select("asset",e,!0,!1)}else e.detail.toggle?t.selected?Editor.Selection.unselect("asset",t._userId,!1):Editor.Selection.select("asset",t._userId,!1,!1):t.selected||Editor.Selection.select("asset",t._userId,!0,!1)},_onItemSelect(e){e.stopPropagation(),e.detail.shift?Editor.Selection.confirm():e.detail.toggle?Editor.Selection.confirm():Editor.Selection.select("asset",e.target._userId,!0)},_onItemRename(e){this.rename(e.target)},_onIconHoverIn(e){e.stopPropagation(),this.showPreviewAfter(e.target,300)},_onIconHoverOut(e){e.stopPropagation(),this.hidePreview()},_onMouseDown(e){1===e.which&&(e.stopPropagation(),this.clearSelection())},_onContextMenu(e){e.preventDefault(),e.stopPropagation();let t=Polymer.dom(e).localTarget;Editor.Selection.setContext("asset",t._userId),Editor.Ipc.sendToMain("assets:popup-context-menu",e.clientX,e.clientY,t.assetType,this.allowAssign,t.id,t.readonly?0:this.copyState)},_onScroll(){this.hidePreview(),this.$.content.scrollLeft=0},_onDragStart(e){this.hidePreview(),e.stopPropagation();let t=Editor.Selection.curSelection("asset");Editor.UI.DragDrop.start(e.dataTransfer,{buildImage:!0,effect:"copyMove",type:"asset",items:t.map(e=>{return{id:e,name:this._id2el[e].name}})})},_onDragEnd(){Editor.UI.DragDrop.end(),Editor.Selection.cancel(),this._cancelHighligting(),this._curInsertParentEL=null},_onDropAreaMove(e){let i=e.detail.dragType;if(e.preventDefault(),e.stopPropagation(),e.target){let s=e.detail.target,n=s=Polymer.dom(s).getOwnerRoot().host,r=Polymer.dom(this),l=this.getBoundingClientRect(),o=e.detail.clientY-l.top+this.$.content.scrollTop;if(0===r.children.length)return;if(n===this&&(n=o<=r.firstElementChild.offsetTop?r.firstElementChild:r.lastElementChild),n.canAddChild||(n=r.lastElementChild),n.canAddChild()||(n=Polymer.dom(n).parentNode),n!==this&&n!==this._curInsertParentEL){this._cancelHighligting(),this._curInsertParentEL=n,this._highlightBorder(n);let s=!0;if(n.canAddChild()){let r=[],l=e.detail.dragItems;if("file"===i)r=(l=(l=Editor.UI.DragDrop.filterFiles(l)).map(e=>e.path)).map(e=>t.basename(e));else if("asset"===i){l=l.map(e=>e.id);let e=this.getToplevelElements(l);for(let t=0;t<e.length;t++){let i=e[t];n!==Polymer.dom(i).parentNode&&r.push(i.name+i.extname)}}if(r.length>0){let e=function(e,t){let i=[];for(let s=0;s<t.length;s++){let n=t[s];for(let t=0;t<e.length;t++){let s=e[t];s.name+s.extname===n&&i.push(s)}}return i}(Polymer.dom(n).children,r);e.length>0&&(this._highlightConflicts(e),"file"!==i&&(s=!1))}}else this._highlightConflicts([]),s=!1;s||Editor.UI.DragDrop.updateDropEffect(e.detail.dataTransfer,"none")}let a="before";o>=s.offsetTop+.5*s.offsetHeight&&(a="after"),this._highlightInsert(s,n,a)}let s="none";"node"===i||"file"===i?s="copy":"asset"===i&&(s="move"),Editor.UI.DragDrop.updateDropEffect(e.detail.dataTransfer,s)},_onDropAreaEnter(e){e.stopPropagation()},_onDropAreaLeave(e){e.stopPropagation(),this._cancelHighligting(),this._curInsertParentEL=null},_onDropAreaAccept(i){i.stopPropagation();let s=this._curInsertParentEL;Editor.Selection.cancel(),this._cancelHighligting(),this._curInsertParentEL=null;let n=i.detail.dragType,r=i.detail.dragItems;if("file"===n?r=(r=Editor.UI.DragDrop.filterFiles(r)).map(e=>e.path):"asset"!==n&&"node"!==n||(r=r.map(e=>e.id)),0===r.length)return;let l=this.getUrl(s);if("node"===n){let e=r[0];Editor.Ipc.sendToPanel("scene","scene:create-prefab",e,l)}else if("asset"===n){if(s){let t=this.getToplevelElements(r);for(let i=0;i<t.length;++i){let n=t[i];if(n!==s&&Polymer.dom(n).parentNode!==s&&!1===n.contains(s)){let t=this.getUrl(n);Editor.assetdb.move(t,e.join(l,e.basename(t)),!0)}}}}else if("file"===n&&s){var o=Polymer.dom(s).children.map(e=>e.name+e.extname);let e=[],i=0;for(i=0;i<r.length;i++){let s=t.basename(r[i]);o.indexOf(s)>=0&&e.push(r[i])}if(e.length>0)for(i=0;i<e.length;i++){var a=e.length-i,h=t.basename(e[i]),d=null,c="";a>1?(d=[Editor.T("MESSAGE.assets.skip"),Editor.T("MESSAGE.assets.merge"),Editor.T("MESSAGE.assets.skip_all"),Editor.T("MESSAGE.assets.merge_all")],c=Editor.T("MESSAGE.assets.left_count",{leftCount:a})):d=[Editor.T("MESSAGE.assets.skip"),Editor.T("MESSAGE.assets.merge")];var m=Editor.Dialog.messageBox({type:"warning",buttons:d,title:Editor.T("MESSAGE.warning"),message:Editor.T("MESSAGE.assets.import_conflict",{fileName:h}),detail:c,noLink:!0,defaultId:0,cancelId:1});if(0===m){let t=r.indexOf(e[i]);t>=0&&r.splice(t,1)}else{if(2===m){for(var f=i;f<e.length;f++){let t=r.indexOf(e[f]);t>=0&&r.splice(t,1)}break}if(3===m)break}}r.length>0&&Editor.assetdb.import(r,l,!0)}},_onRenameMouseDown(e){e.stopPropagation()},_onRenameKeyDown(e){e.stopPropagation()},_onRenameValueChanged(){let t=this.$.nameInput._renamingEL;if(t){let i=this.getUrl(t),s=e.join(e.dirname(i),this.$.nameInput.value+t.extname);if(!this.$.nameInput.value)return Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.ok")],title:Editor.T("MESSAGE.warning"),message:Editor.T("MESSAGE.assets.failed_to_move",{srcUrl:i,destUrl:s}),detail:"Can not use empty name",noLink:!0}),void 0;Editor.assetdb.move(i,s,!0),this.$.nameInput._renamingEL=null,this.$.nameInput.hidden=!0}},_onRenameFocusChanged(e){this.$.nameInput._renamingEL&&(this._renameFocused=e.detail.value,setTimeout(()=>{this._renameFocused||(this.$.nameInput._renamingEL=null,this.$.nameInput.hidden=!0)},1))},_highlightBorder(e){if(e&&"ASSETS-ITEM"===e.tagName){let t=this.$.highlightBorder.style;t.display="block",t.left=e.offsetLeft-2+"px",t.top=e.offsetTop-1+"px",t.width=e.offsetWidth+4+"px",t.height=e.offsetHeight+3+"px",e.highlighted=!0}else this.$.highlightBorder.style.display="none"},_highlightInsert(e,t,i){let s=this.$.insertLine.style;e===this&&(e=Polymer.dom(this).firstChild),e===t?s.display="none":e&&t&&(s.display="block",s.left=t.offsetLeft+"px",s.top="before"===i?e.offsetTop+"px":e.offsetTop+e.offsetHeight+"px",s.width=t.offsetWidth+"px",s.height="0px")},_highlightConflicts(e){for(let t=0;t<e.length;++t){let i=e[t];!1===i.conflicted&&(i.conflicted=!0,this._conflictElements.push(i))}this._curInsertParentEL&&(this._curInsertParentEL.invalid=!0),this.$.highlightBorder.setAttribute("invalid","")},_cancelHighligting(){this.$.highlightBorder.style.display="none",this.$.highlightBorder.removeAttribute("invalid"),this.$.insertLine.style.display="none",this._curInsertParentEL&&(this._curInsertParentEL.highlighted=!1,this._curInsertParentEL.invalid=!1),this._conflictElements.forEach(e=>{e.conflicted=!1}),this._conflictElements=[]},_canUseParent(e){let t=Polymer.dom(e).parentNode,i=Polymer.dom(t);return!(!e.isSubAsset||i.children[0]!==e||e.name!==t.name)}})})();