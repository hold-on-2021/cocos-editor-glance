(function(){"use strict";const e=require("fire-url"),t=require("fire-path"),s=require("fire-fs"),i=Editor.require("packages://assets/panel/utils");Editor.polymerPanel("assets",{properties:{activeItemUrl:{type:String,value:"db://"},searchPattern:{type:String,value:"",observer:"_onSearchPatternChanged"}},listeners:{"assets-tree-ready":"_onAssetsTreeReady","open-asset":"_onOpenAsset","start-loading":"_onStartLoading","finish-loading":"_onFinishLoading"},"panel-ready"(){this._activeWhenCreated=null,this._isGroupCreated=!1,this.$.tree.refresh()},close(){let e=this.$.tree.dumpItemStates();this.profiles.local.data["item-states"]=e,this.profiles.local.save()},focusOnSearch(e){e&&e.stopPropagation(),this.$.search.setFocus()},async copyFile(e){e&&(e.stopPropagation(),e.preventDefault()),this._copyUuids=null;let t=[],s=Editor.Selection.curSelection("asset");for(let e=0;e<s.length;e++)await i.isReadOnly(s[0])||t.push(s[0]);this._copyUuids=t.length>0?t:null,this._copyUuids&&(this.$.tree.copyState=2|this.$.tree.copyState)},async pasteFile(e){e&&(e.stopPropagation(),e.preventDefault());let s=Editor.Selection.curActivate("asset"),r="";if("mount-assets"===s?r=Editor.url("db://assets"):Editor.Utils.UuidUtils.isUuid(s)&&(r=await i.uuid2path(s)),!await i.isDir(r)&&(r=t.dirname(r),!await i.isDir(r)))return Editor.warn("The selected location is not a folder.");if(this._copyUuids&&await i.exists(r))for(let e=0;e<this._copyUuids.length;e++){let s=this._copyUuids[e];if(await i.isReadOnly(s))return;let a=await i.uuid2path(s);if(!a)return Editor.warn(`File is missing - ${s}`);let d=t.basename(a),l=t.join(r,d);if(i.isSubDir(t.dirname(l),t.dirname(a)))return Editor.warn(`Cannot place directory into itself - ${s}`);if(l=await i.copy(a,l),!l)return;let n=t.relative(Editor.url("db://assets"),l);Editor.assetdb.refresh(`db://assets/${n}`)}},selectAll(e){e&&(e.stopPropagation(),e.preventDefault()),this.curView().selectAll()},selectPrev(e){e&&(e.stopPropagation(),e.preventDefault()),this.curView().selectPrev(!1)},selectNext(e){e&&(e.stopPropagation(),e.preventDefault()),this.curView().selectNext(!1)},shiftSelectPrev(e){e&&(e.stopPropagation(),e.preventDefault()),this.curView().selectPrev(!0)},shiftSelectNext(e){e&&(e.stopPropagation(),e.preventDefault()),this.curView().selectNext(!0)},foldCurrent(e){e&&(e.stopPropagation(),e.preventDefault());let t=this.$.tree._activeElement;t&&t.foldable&&!t.folded&&(t.folded=!0)},foldupCurrent(e){e&&(e.stopPropagation(),e.preventDefault());let t=this.$.tree._activeElement;t&&t.foldable&&t.folded&&(t.folded=!1)},renameCurrentSelected(e){e&&(e.stopPropagation(),e.preventDefault()),this.curView()._activeElement&&this.curView().rename(this.curView()._activeElement)},deleteCurrentSelected(e){e&&(e.stopPropagation(),e.preventDefault());let t=Editor.Selection.curSelection("asset");this._deleteAssets(t)},curView(){return this.$.searchResult.hidden?this.$.tree:this.$.searchResult},messages:{"assets:copy"(e,t){let s=Editor.Selection.curSelection("asset");-1===s.indexOf(t)?this._copyUuids=[t]:this._copyUuids=s,this.$.tree.copyState=2|this.$.tree.copyState},async"assets:paste"(e,s){let r=await i.uuid2path(s);if(!await i.isDir(r)&&(r=t.dirname(r),!await i.isDir(r)))return Editor.warn("The selected location is not a folder.");if(this._copyUuids&&await i.exists(r))for(let e=0;e<this._copyUuids.length;e++){let s=this._copyUuids[e];if(await i.isReadOnly(s))return;let a=await i.uuid2path(s);if(!a)return Editor.warn(`File is missing - ${s}`);let d=t.basename(a),l=t.join(r,d);if(i.isSubDir(t.dirname(l),t.dirname(a)))return Editor.warn(`Cannot place directory into itself - ${s}`);if(l=await i.copy(a,l),!l)return;let n=t.relative(Editor.url("db://assets"),l);Editor.assetdb.refresh(`db://assets/${n}`)}},"selection:selected"(e,t,s){"asset"===t&&s.forEach(e=>{this.$.tree.selectItemById(e),this.$.searchResult.hidden||this.$.searchResult.selectItemById(e)})},"selection:unselected"(e,t,s){"asset"===t&&s.forEach(e=>{this.$.tree.unselectItemById(e),this.$.searchResult.hidden||this.$.searchResult.unselectItemById(e)})},"selection:activated"(e,t,s){"asset"===t&&s&&(this.curView().activeItemById(s),this.curView()._activeElement&&(this.activeItemUrl=this.curView().getUrl(this.curView()._activeElement)))},"selection:deactivated"(e,t,s){"asset"===t&&(this.curView().deactiveItemById(s),this.activeItemUrl="db://")},"asset-db:assets-created"(e,s){let i=[];s.forEach(e=>{if(e.hidden)return;let r=t.basenameNoExt(e.path),a=t.extname(e.path);if("folder"===e.type?(r=t.basename(e.path),a=""):"mount"===e.type&&(r=e.name,a=""),this.$.tree.addNewItemById(e.uuid,e.parentUuid,{name:r,extname:a,assetType:e.type,isSubAsset:e.isSubAsset,readonly:e.readonly}),this._activeWhenCreated===e.url&&(this._activeWhenCreated=null,Editor.Selection.select("asset",e.uuid)),this.$.searchResult.hidden){s.some(t=>t.uuid===e.parentUuid)||i.push(e)}else if(this.$.searchResult.validate(r,this.searchPattern)){let t=document.createElement("assets-item");this.$.searchResult.addItem(this.curView(),t,{id:e.uuid,name:r,assetType:e.type,extname:a,isSubAsset:e.isSubAsset,realUrl:e.url,readonly:e.readonly}),t.setIcon(e.type),i.push(e)}});let r=this.curView();if(i.forEach(e=>{window.requestAnimationFrame(()=>{r._id2el[e.uuid].hint();let t=r._id2el[e.parentUuid];t&&(t.folded=!1)})}),i.length){let e=i[0],t=r._id2el[e.uuid];r.scrollToItem(t)}},"asset-db:assets-moved"(e,s){let i=Editor.Utils.arrayCmpFilter(s,(e,s)=>t.contains(e.srcPath,s.srcPath)?1:t.contains(s.srcPath,e.srcPath)?-1:0),r=Editor.Selection.curActivate("asset");i.forEach(e=>{Editor.assetdb.queryInfoByUuid(e.uuid,(s,i)=>{let a=!1;var d="";if(d="folder"===i.type?t.basename(e.destPath):t.basenameNoExt(e.destPath),this.$.tree.moveItemById(e.uuid,e.parentUuid,d),!this.$.searchResult.hidden)if(this.$.searchResult.validate(d,this.searchPattern)){this.$.searchResult.moveItemById(e.uuid,e.parentUuid,d);this.curView()._id2el[e.uuid].realUrl=e.url}else this.$.searchResult.removeItemById(e.uuid),a=!0;r&&r===e.uuid&&(this.activeItemUrl=a?"db://":e.url)})}),i.forEach(e=>{window.requestAnimationFrame(()=>{let t=this.curView()._id2el[e.uuid];t&&t.hint()})})},"asset-db:assets-deleted"(e,t){t.forEach(e=>{this.$.tree.removeItemById(e.uuid),this.$.searchResult.hidden||this.$.searchResult.removeItemById(e.uuid)});let s=t.map(e=>e.uuid);Editor.Selection.unselect("asset",s,!0)},"asset-db:asset-changed"(e,t){let s=this.curView()._id2el[t.uuid];s&&(s.hint(),"texture"!==t.type&&"sprite-frame"!==t.type||s.setIcon(t.type))},"asset-db:asset-uuid-changed"(e,t){let s=this.curView()._id2el[t.oldUuid];this.curView().updateItemID(s,t.uuid),s.hint()},"assets:hint"(e,t){this.curView().hintItemById(t)},"assets:search"(e,t){this.$.searchResult.allowAssign=!0,this.searchPattern=t},"assets:clearSearch"(e){this.$.searchResult.allowAssign=!1},"assets:new-asset"(i,r,a){let d,l,n;if(a){let e=Editor.Selection.contexts("asset");if(e.length>0){let s=e[0];"folder"===(l=this.curView()._id2el[s]).assetType||"mount"===l.assetType?n=this.curView().getUrl(l):(d=this.curView().getUrl(l),n=t.dirname(d))}else!1===this.$.tree.hidden?(l=Polymer.dom(this.curView()).firstElementChild,n=this.curView().getUrl(l)):n="db://assets"}else{let e=Editor.Selection.curActivate("asset");e?(l=this.curView()._id2el[e],d=this.curView().getUrl(l),n=Polymer.dom(l).parentNode!==this.curView()?t.dirname(d):d):!1===this.$.tree.hidden?(l=Polymer.dom(this.curView()).firstElementChild,n=this.curView().getUrl(l)):n="db://assets"}let o=()=>{this._activeWhenCreated=h;let e=this;Editor.assetdb.create(h,c,function(t,s){setTimeout(function(){let t=s[0].uuid,i=e.curView()._id2el[t];i&&e.curView().rename(i)},0)})},c=r.data;r.url&&(c=s.readFileSync(Editor.url(r.url),{encoding:"utf8"}));let h=e.join(n,r.name);if(".fire"===e.extname(h)){let e=cc.deserialize(c,{createAssetRefs:!0}),t=cc.find("Canvas",e.scene);if(!t)return Editor.error("canvas node not found"),void 0;let s=t.getComponent(cc.Canvas);if(!s)return Editor.error("canvas component not found"),void 0;_Scene._applyCanvasPreferences(s,()=>{c=Editor.serialize(e),o()})}else o()},"assets:find-usages"(e,t){this.searchPattern="used:"+t},"assets:rename"(e,t){let s=this.curView()._id2el[t];s&&this.curView().rename(s)},"assets:delete"(e,t){this._deleteAssets(t)},"assets:start-refresh"(){this.showLoaderAfter(100)},"assets:end-refresh"(){this.hideLoader()}},showLoaderAfter(e){!1!==this.$.loader.hidden&&(this._loaderID||(this._loaderID=setTimeout(()=>{this.$.loader.hidden=!1,this._loaderID=null},e)))},hideLoader(){clearTimeout(this._loaderID),this._loaderID=null,this.$.loader.hidden=!0},_deleteAssets(e){let t=e.map(e=>{let t=this.curView()._id2el[e];return this.curView().getUrl(t)}),s=t;s.length>3&&(s=s.slice(0,3)).push("..."),s=s.join("\n");0===Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.delete"),Editor.T("MESSAGE.cancel")],title:Editor.T("MESSAGE.assets.delete_title"),message:Editor.T("MESSAGE.assets.delete_message")+"\n"+s,detail:Editor.T("MESSAGE.assets.delete_detail"),defaultId:0,cancelId:1,noLink:!0})&&Editor.assetdb.delete(t)},_onStartLoading(e){this.showLoaderAfter(e.detail)},_onFinishLoading(){this.hideLoader()},_onAssetsTreeReady(){let e=this.profiles.local;this.$.tree.restoreItemStates(e.data["item-states"]);Editor.Selection.curSelection("asset").forEach(e=>{this.$.tree.selectItemById(e)});let t=Editor.Selection.curActivate("asset");t&&(this.$.tree.activeItemById(t),this.activeItemUrl=this.curView().getUrl(this.curView()._activeElement))},_onOpenAsset(e){let t=e.detail.uuid;Editor.assetdb.queryInfoByUuid(t,(e,s)=>{switch(s.type){case"javascript":case"coffeescript":case"typescript":case"markdown":case"bitmap-font":case"text":Editor.Ipc.sendToMain("assets:open-text-file",t);break;case"scene":Editor.Ipc.sendToMain("scene:open-by-uuid",t);break;case"sprite-frame":Editor.Panel.open("sprite-editor",{uuid:t});break;case"texture":Editor.Ipc.sendToMain("assets:open-texture-file",t);break;case"prefab":Editor.Ipc.sendToAll("scene:enter-prefab-edit-mode",t);break;case"folder":let e=this.$.tree._id2el[t];e.folded=!e.folded}})},_onCreateClick(){let e=this.$.createBtn.getBoundingClientRect();Editor.Ipc.sendToMain("assets:popup-create-menu",e.left,e.bottom+5)},_onSearchPatternChanged(){if(this.searchPattern)return this.$.tree.hidden=!0,this.$.searchResult.hidden=!1,this.$.searchResult.clear(),this.$.searchResult.search(this.searchPattern),void 0;this.fire("finish-loading"),this.$.tree.hidden=!1,this.$.searchResult.hidden=!0,this.$.searchResult.clear()},_onClear(e){e.stopPropagation();let t=Editor.Selection.curSelection("asset"),s=!1;if(t.forEach(e=>{if(this.$.searchResult._id2el[e])return s=!0,void 0;s=!1}),s){this.searchPattern="",this.$.tree.hintItemById(t[0]);for(let e=1;e<t.length;++e)this.$.tree._id2el[t[e]].hint()}},_onSearchConfirm(e){e.detail.confirmByEnter&&this.async(()=>{if(!this.$.searchResult.hidden)return this.$.searchResult.setFocus(),void 0;this.$.tree.setFocus()})}})})();