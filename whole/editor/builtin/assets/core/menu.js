"use strict";function getSelectedUuid(){let e=Editor.Selection.contexts("asset");return e.length>0?e[0]:""}function getImportInfo(e){let t=Editor.assetdb.loadMetaByUuid(e);if(!t)return Editor.info(e+" does not exists in library"),{};if(t.useRawfile())return Editor.info("This is a raw asset, it does not exists in library"),{};let s=t.dests(Editor.assetdb);return 0!==s.length&&Fs.existsSync(s[0])?{path:s[0],type:t.assetType()}:(Editor.failed("The asset %s is not exists in library",Editor.assetdb.uuidToUrl(e)),{})}function getContextTemplate(e,t,s,r){var i=[{label:Editor.T("ASSETS.create"),submenu:getCreateTemplate(!0,e,s)},{type:"separator"},{label:Editor.T("ASSETS.copy"),enabled:!!(1&r),click(){let e=getSelectedUuid();e&&Editor.Ipc.sendToPanel("assets","assets:copy",e)}},{label:Editor.T("ASSETS.paste"),enabled:!!(2&r),click(){let e=getSelectedUuid();e&&Editor.Ipc.sendToPanel("assets","assets:paste",e)}},{type:"separator"},{label:Editor.T("ASSETS.rename"),click(){let e=getSelectedUuid();e&&Editor.Ipc.sendToPanel("assets","assets:rename",e)}},{label:Editor.T("ASSETS.delete"),click(){let e=Editor.Selection.contexts("asset");e.length>0&&Editor.Ipc.sendToPanel("assets","assets:delete",e)}}];let l=Editor.assetdb.getAssetBackupPath(Editor.assetdb.uuidToFspath(s));return l&&Fs.existsSync(l)&&i.push({label:Editor.T("ASSETS.rollback"),click(){let e=Editor.assetdb.uuidToUrl(s);1===Editor.Dialog.messageBox({type:"warning",buttons:["Cancel","OK"],title:"Rollback Asset",message:Editor.T("ASSETS.sure_rollback",{url:e}),defaultId:0,cancelId:0,noLink:!0})&&Async.waterfall([function(t){Fs.readFile(l,(s,r)=>{if(s)return t(s);Editor.assetdb.saveExists(e,r,t=>{if(t)return Editor.error(`Rollback ${e} failed: ${t.stack}`),void 0;Editor.Dialog.messageBox({type:"warning",buttons:["OK"],title:"Rollback Asset",message:Editor.T("ASSETS.rollback_tip",{url:e}),defaultId:0,cancelId:0,noLink:!0})})})}],function(e){e&&Editor.warn(Editor.T("ERROR.assets.rollback"))})}}),i=i.concat([{type:"separator"},{label:Editor.T("ASSETS.find_usages"),click(){let e=getSelectedUuid();e&&Editor.Ipc.sendToPanel("assets","assets:find-usages",e)}},{label:Editor.isDarwin?Editor.T("ASSETS.reveal_mac"):Editor.T("ASSETS.reveal_win"),click(){let e=getSelectedUuid();if(e){let t=Editor.assetdb.uuidToFspath(e);Fs.existsSync(t)?Electron.shell.showItemInFolder(t):Editor.failed("Can not found the asset %s",Editor.assetdb.uuidToUrl(e))}}},{type:"separator"},{label:Editor.T("ASSETS.open_in_library"),click(){let e=getSelectedUuid();if(e){let{path:t}=getImportInfo(e);t&&Editor.Ipc.sendToMain("assets:open-text-file-by-path",t)}}},{label:Editor.T("ASSETS.reveal_library"),click(){let e=getSelectedUuid();if(e){let{path:t}=getImportInfo(e);t&&Electron.shell.showItemInFolder(t)}}},{label:Editor.T("ASSETS.reveal_hierarchy"),visible:"javascript"===e||"coffeescript"===e||"typescript"===e,click(){let e=getSelectedUuid();if(e){let t=Editor.assetdb.uuidToUrl(e);Editor.Ipc.sendToPanel("hierarchy","hierarchy:filter",`t:${Url.basenameNoExt(t)}`)}}},{label:Editor.T("ASSETS.show_uuid"),click(){let e=getSelectedUuid();if(e){let t=Editor.assetdb.uuidToUrl(e),s=Editor.Utils.UuidUtils.compressUuid(e,!0);Editor.info(`${e} (${s}), ${t}`)}}},{type:"separator"},{label:Editor.T("ASSETS.click_assign"),enabled:t,click(){let e=getSelectedUuid();e&&Editor.Ipc.sendToPanel("inspector","select-search-asset",e)}}]),i}function getCreateTemplate(e,t,s){let r=createMenu();r.forEach(t=>{t.params&&t.params.push(e)});let i=[{label:Editor.T("ASSETS.folder"),message:"assets:new-asset",params:[{name:"New Folder"},e]}];return i.push({type:"separator"}),i.concat(r)}const Electron=require("electron"),Fs=require("fire-fs"),Async=require("async"),Url=require("fire-url"),createMenu=require("./create-menu");module.exports={getContextTemplate:getContextTemplate,getCreateTemplate:getCreateTemplate};