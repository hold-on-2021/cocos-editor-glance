(()=>{"use strict";Editor.polymerPanel("hierarchy",{properties:{searchPattern:{type:String,value:"",observer:"_onSearchPatternChanged"}},listeners:{"update-scene-failed":"disconnectScene","tree-changed":"_onTreeChanged","panel-copy":"_onPanelCopy","panel-paste":"_onPanelPaste"},ready(){this.waitForSceneReady()},"panel-ready"(){Editor.Ipc.sendToPanel("scene","scene:is-ready",(e,t)=>{t&&this.connectScene()},-1)},_T:function(e){return Editor.T(e)},close(){let e=this.$.tree.dumpItemStates();this.profiles.local.data["item-states"]=e,this.profiles.local.save()},focusOnSearch(e){e&&e.stopPropagation(),this.$.search.setFocus()},selectAll(e){e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording||this.curView().selectAll()},selectPrev(e){e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording||this.curView().selectPrev(!1)},selectNext(e){e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording||this.curView().selectNext(!1)},shiftSelectPrev(e){e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording||this.curView().selectPrev(!0)},shiftSelectNext(e){e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording||this.curView().selectNext(!0)},foldCurrent(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording)return;let t=this.$.tree._activeElement;t&&t.foldable&&!t.folded&&(t.folded=!0)},foldupCurrent(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording)return;let t=this.$.tree._activeElement;t&&t.foldable&&t.folded&&(t.folded=!1)},renameCurrentSelected(e){e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording||this.curView()._activeElement&&this.curView().rename(this.curView()._activeElement)},deleteCurrentSelected(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording)return;let t=Editor.Selection.curSelection("node");Editor.Ipc.sendToPanel("scene","scene:delete-nodes",t)},duplicateCurrentSelected(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.$.tree.recording)return;let t=Editor.Selection.curSelection("node");Editor.Ipc.sendToPanel("scene","scene:duplicate-nodes",t)},centerCurrentSelected(e){e&&(e.stopPropagation(),e.preventDefault());let t=Editor.Selection.curSelection("node");Editor.Ipc.sendToWins("scene:center-nodes",t)},curView(){return this.$.searchResult.hidden?this.$.tree:this.$.searchResult},messages:{"selection:selected"(e,t,r){"node"===t&&r.forEach(e=>{this.$.tree.selectItemById(e),this.$.tree.expand(e,!0),this.$.searchResult.hidden||this.$.searchResult.selectItemById(e)})},"selection:unselected"(e,t,r){"node"===t&&r.forEach(e=>{this.$.tree.unselectItemById(e),this.$.searchResult.hidden||this.$.searchResult.unselectItemById(e)})},"selection:activated"(e,t,r){"node"===t&&this.curView().activeItemById(r)},"selection:deactivated"(e,t,r){"node"===t&&this.curView().deactiveItemById(r)},"selection:hoverin"(e,t,r){"node"===t&&this.curView().hoverinItemById(r)},"selection:hoverout"(e,t,r){"node"===t&&this.curView().hoveroutItemById(r)},"scene:ready"(){this.connectScene()},"scene:reloading"(){this.waitForSceneReady()},"hierarchy:hint"(e,t){this.$.tree.hintItemById(t)},"hierarchy:rename"(e,t){let r=this.$.tree._id2el[t];r&&this.$.tree.rename(r)},"hierarchy:delete"(e,t){Editor.Selection.unselect("node",t,!0),Editor.Ipc.sendToPanel("scene","scene:delete-nodes",t)},"hierarchy:duplicate"(e,t){Editor.Ipc.sendToPanel("scene","scene:duplicate-nodes",t)},"hierarchy:show-path"(e,t){let r=this.$.tree.getPathByID(t).replace(/\\/g,"/");Editor.info(`Path: ${r}, UUID: ${t}`)},"hierarchy:filter"(e,t){this.$.searchResult.allowAssign=!0,this.searchPattern=t},"hierarchy:clearFilter"(){this.$.searchResult.allowAssign=!1},"hierarchy:enter-record-mode"(e,t){this.$.tree.enterRecord(t),Editor.Ipc.sendToMain("hierarchy:enter-record-mode")},"hierarchy:exit-record-mode"(){this.$.tree.exitRecord(),Editor.Ipc.sendToMain("hierarchy:exit-record-mode")}},waitForSceneReady(){this.$.loader.hidden=!1,this.connectState="waiting"},connectScene(){"connected"!==this.connectState&&(this.$.loader.hidden=!0,this.connectState="connected",this.$.tree._localStates=this.profiles.local.data["item-states"],this.$.tree._refreshTreeState=!0,this._queryHierarchyAfter(0))},disconnectScene(){this._queryID&&(this.cancelAsync(this._queryID),this._queryID=null),this.connectState="disconnected"},_queryHierarchyAfter(e){this._queryID&&(this.cancelAsync(this._queryID),this._queryID=null);let t=this.async(()=>{Editor.Ipc.sendToPanel("scene","scene:query-hierarchy",(e,t,r)=>{e||(this.$.tree._updateSceneGraph(t,r),this._queryHierarchyAfter(100))},-1)},e);this._queryID=t},_connectClass(e){switch(e){case"waiting":return"fa fa-link waiting";case"connected":return"fa fa-link";case"disconnected":return"fa fa-unlink"}return"fa fa-unlink"},_onStateClick(e){e.stopPropagation(),this.connectScene()},_onCreateClick(){let e=this.$.createBtn.getBoundingClientRect();Editor.Ipc.sendToMain("hierarchy:popup-create-menu",e.left,e.bottom+5,this.$.tree.recording)},_onSearchPatternChanged(){if(this.$.searchResult.filter(this.searchPattern,this.$.tree._id2el),this.searchPattern)return this.$.searchResult.hidden=!1,this.$.tree.hidden=!0,void 0;this.$.searchResult.hidden=!0,this.$.searchResult.clear(),this.$.tree.hidden=!1},_onTreeChanged(){this.$.searchResult.hidden||this.$.searchResult.filter(this.searchPattern,this.$.tree._id2el)},_onPanelCopy(){let e=Editor.Selection.curSelection("node");Editor.Ipc.sendToPanel("scene","scene:copy-nodes",e)},_onPanelPaste(){if(this.$.tree.recording)return alert(Editor.T("MESSAGE.animation_editor.can_not_modify_hierarchy"));let e=Editor.Selection.curActivate("node");Editor.Ipc.sendToPanel("scene","scene:paste-nodes",e)},_onClear(e){e.stopPropagation();let t=Editor.Selection.curSelection("node"),r=!1;if(t.forEach(e=>{if(this.$.searchResult._id2el[e])return r=!0,void 0;r=!1}),r){this.searchPattern="",this.$.tree.hintItemById(t[0]);for(let e=1;e<t.length;++e)this.$.tree._id2el[t[e]].hint()}}})})();