function _arrayBufferToBase64(e){let t="",r=new Uint8Array(e),s=r.byteLength;for(let e=0;e<s;e++)t+=String.fromCharCode(r[e]);return window.btoa(t)}var Fs=require("fire-fs"),Path=require("fire-path"),Async=require("async"),Utils=require("../utils"),JSZip=require("../lib/jszip.min"),JSZipUtils=require("../lib/jszip-utils.min"),NodeUuid=require("node-uuid");let ResInfo=function(e,t){let r=Path.parse(e);this.name=r.name+r.ext,this.path=e,this.type="",this.icon="",this.selected=!0,this.parent=t},FolderRoot=function(e,t){let r=Path.parse(e);this.name=r.name,this.path=e,this.children=[],this.type="directory",this.folded=!0,this.selected=!0,this.parent=t},analyticalRrrTitle=Editor.T("IMPORT_ASSET.parse_zip_err_title"),analyticalRrrMsg=Editor.T("IMPORT_ASSET.parse_zip_err_content"),importRrrTitle=Editor.T("IMPORT_ASSET.err_title");module.exports={tempPath:Path.join(Editor.projectInfo.path,"temp","packageAsset","/"),_onInit(e){this._folderArr=[],this._assetTypeArr=[],this._imgArr=[],this._treeRoot=new FolderRoot(e),this._basePath=e,this._outPath="",this._conflictAssets=[]},_getFolderInfo(e){return this._folderArr[e]},_getParent(e){let t=Path.parse(e);if(!t.dir)return null;let r=this._getFolderInfo(t.dir);return r||this._getParent(t.dir)},_getTypeByName(e){return this._assetTypeArr[e]},_getIcon(e,t){return"texture"===t||"sprite-frame"===t?this._imgArr[e]:"unpack://static/icon/assets/"+t+".png"},_addAsset(e,t){let r=Path.parse(e);if(!r.dir&&t)if(r.ext){let r=new ResInfo(e,t);-1===t.children.indexOf(r)&&(r.type=this._getTypeByName(r.name),r.icon=this._getIcon(r.name,r.type),t.children.push(r))}else{let s=new FolderRoot(e,t);-1===t.children.indexOf(s)&&(t.children.push(s),this._folderArr[r.name]=s)}else{let t=this._getFolderInfo(r.dir);if(t||(t=new FolderRoot(r.dir,this._getParent(r.dir)),this._folderArr[r.dir]=r),r.ext){let r=new ResInfo(e,t);-1===t.children.indexOf(r)&&(r.type=this._getTypeByName(r.name),r.icon=this._getIcon(r.name,r.type),t.children.push(r))}else{let s=new FolderRoot(e,t);if(-1===t.children.indexOf(s)){t.children.push(s);let e=r.dir+"/"+r.name;this._folderArr[e]=s}}}},_addImageAsset(e,t){let r=Path.parse(e.name);e.async("arraybuffer").then(s=>{let i=_arrayBufferToBase64(s),a=e.name.indexOf("."),n=e.name.substr(a+1);this._imgArr[r.name+r.ext]="data:image/"+n+";base64,"+i,this._addAsset(e.name,t)})},_analyticalContent(e,t){let r=Path.parse(e.name);r.base===Utils.ASSET_TYPE||".meta"===r.ext||(".png"===r.ext||".jpg"===r.ext?this._addImageAsset(e,this._treeRoot):this._addAsset(e.name,this._treeRoot)),t()},_analyticalZip(e,t){JSZipUtils.getBinaryContent(e,(e,r)=>{if(e)return t&&t(e),void 0;JSZip.loadAsync(r).then(e=>{try{e.file(Utils.ASSET_TYPE).async("string").then(r=>{this._assetTypeArr=JSON.parse(r),Async.each(e.files,(e,t)=>{this._analyticalContent(e,t)},t)})}catch(e){Utils.showErrorMessageBox(analyticalRrrTitle,analyticalRrrMsg),t&&t(analyticalRrrMsg)}},e=>{Utils.showErrorMessageBox(analyticalRrrTitle,analyticalRrrMsg),t&&t(analyticalRrrMsg)})})},analyticalZip(e,t){this._onInit(e),this._analyticalZip(e,e=>{if(e)return t(e,null);t(null,this._treeRoot)})},_addNeedImport(e,t,r){e.selected&&(t[e.name]=e,t[e.name+".meta"]=e),Async.each(e.children,(r,s)=>{if(r.selected&&(t[r.name]=r,t[r.name+".meta"]=e),"directory"!==r.type)return s();this._addNeedImport(r,t,s)},r)},_queryNeedImportAsset(e,t){let r=[];Async.each(e.children,(e,t)=>{this._addNeedImport(e,r,t)},()=>{t(null,r)})},_importContent(e,t,r){let s=Path.parse(e.name),i=Path.join(this._outPath,e.name);if(".meta"===s.ext){let s=Object.keys(t);e.async("string").then(e=>{Fs.writeFileSync(i,e),s.forEach(r=>{if(Fs.existsSync(i)&&(e=Fs.readFileSync(i,"utf8")),-1!==e.indexOf(r)){let s=new RegExp(r,"g");e=e.replace(s,t[r]),Fs.writeFileSync(i,e)}}),r()})}else if(".prefab"===s.ext||".fire"===s.ext||".anim"===s.ext){let s=Object.keys(t);e.async("string").then(e=>{Fs.writeFileSync(i,e),s.forEach(r=>{if(Fs.existsSync(i)&&(e=Fs.readFileSync(i,"utf8")),-1!==e.indexOf(r)){let s=new RegExp(r,"g");e=e.replace(s,t[r]),Fs.writeFileSync(i,e)}}),r()})}},_checkMeta(e,t,r){let s=[];Async.each(e,(e,r)=>{let i=Path.parse(e.name),a=t[i.name+i.ext];".meta"===i.ext&&a?e.async("string").then(e=>{let t=JSON.parse(e),a=Editor.remote.assetdb.uuidToFspath(t.uuid);if(a){if(a!==Path.join(this._outPath,i.dir,i.name)){s[t.uuid]=NodeUuid.v4();Object.keys(t.subMetas).forEach(e=>{let r=t.subMetas[e];s[r.uuid]=NodeUuid.v4()})}}r()}):r()},()=>{r(null,s)})},_importAssets(e,t){JSZipUtils.getBinaryContent(this._basePath,(r,s)=>{r||JSZip.loadAsync(s).then(r=>{try{let s=r.files,i=Object.keys(s);if(0===i.length)return;this._progressInfo.total=i.length,this._checkMeta(s,e,(r,i)=>{let a=Editor.T("IMPORT_ASSET.confirmation_box_title"),n=Editor.T("IMPORT_ASSET.confirmation_box_content",{outPath:this._outPath});Utils.showImportMessageBox(a,n,(r,a)=>{!r&&a&&Async.each(s,(t,r)=>{let s=Path.parse(t.name);if(e[s.name+s.ext]){let e=Path.join(this._outPath,t.name);t.dir?(Utils.createFolder(Path.join(Path.dirname(e),s.name)),this._updatePorgress(t),r()):".meta"!==s.ext&&".prefab"!==s.ext&&".fire"!==s.ext&&".anim"!==s.ext?t.nodeStream().pipe(Fs.createWriteStream(e)).on("finish",()=>{this._updatePorgress(t),r()}):this._importContent(t,i,()=>{this._updatePorgress(t),r()})}else r()},t)})})}catch(e){Utils.showErrorMessageBox(analyticalRrrTitle,analyticalRrrMsg),t&&t(analyticalRrrMsg)}})})},importZip(e,t,r){if(this._outPath=e,this._initPorgress(r),!Fs.existsSync(e)){let t=Editor.T("IMPORT_ASSET.err_title"),r=Editor.T("IMPORT_ASSET.err_info_not_exist",{outPath:e});return Utils.showErrorMessageBox(t,r),void 0}this._queryNeedImportAsset(t,(e,t)=>{this._importAssets(t,()=>{this._completePorgress(),Editor.assetdb.refresh("db://assets/")})})},_initPorgress(e){this._progressInfo={curProgress:0,total:0,outStrLog:""},this._progressCallback=e},_updatePorgress(e){let t=(e.dir?Editor.T("IMPORT_ASSET.folder"):Editor.T("IMPORT_ASSET.file"))+" "+e.name;this._progressInfo.outStrLog=Editor.T("IMPORT_ASSET.progress_state_import",{name:t}),this._progressInfo.curProgress++,this._sendPorgressCallback()},_sendPorgressCallback(){this._progressCallback(this._progressInfo)},_completePorgress(){this._progressInfo.curProgress=this._progressInfo.total,this._progressInfo.outStrLog=Editor.T("IMPORT_ASSET.progress_state_end"),this._sendPorgressCallback()}};