function replaceExtname(e,t){return Path.stripExt(e)+t}function runExport(e,t,r){function s(e){u.isRunning?u.stop(e):Editor.error(e)}function i(t){var r=e,s=Editor.assetdb.mountInfoByPath(t);s?r=Path.join(r,s.mountPath):Editor.error("Can not get mount info of "+t);var i=Editor.assetdb.getRelativePath(t);return Path.resolve(r,i)}function o(e){var t=Editor.assetdb.uuidToFspath(e);if(!t)return Editor.error("Can not get fspath of "+e),void 0;var r=i(t);f.add(t,r,!0,e)}debugSkipRebuild&&Editor.warn("skip rebuild");var a=Path.join(e,"__temp__");let n=t.scenes;var u=new Gulp,d=GulpSequence.use(u);u.task("clean",function(t){var r=[Path.join(e,"**/*")];debugSkipRebuild&&(r=[r,"!"+a]),Editor.log("Delete "+r),Del(r,{force:!0},t)}),u.task("get-scenes",function(e){n||debugSkipRebuild?e():Editor.assetdb.queryAssets(null,"scene",function(t,r){if(t)return s(t);n=r.map(e=>e.uuid),e()})});var p,l;u.task("build-assets",["get-scenes"],function(e){function t(t,s){if(r&&!debugBuildWorker){var i=r;r=null,i.nativeWin.destroy()}u.isRunning?e(new Error(s)):Editor.error(s)}if(debugSkipRebuild)return e();p=null;var r,i="app:build-project-abort";ipcMain.once(i,t);var o=!1;Editor.App.spawnWorker("app://editor/page/build/build-worker",function(u,d){r=u;var f;o||(o=!0,d.once("closed",function(){f||(ipcMain.removeListener(i,t),e())})),r.send("app:init-build-worker",BUILD_PLATFORM,!0,function(e){function t(){!r||debugBuildWorker||(r.close(),r=null)}e?(s(e),f=!0,t()):r&&r.send("app:build-assets",a,BUILD_PLATFORM,!0,{scenes:n,inlineSpriteFrames:!1,mergeStartScene:!1,optimizeHotUpdate:!1},function(e,r,i,o){e?(s(e),f=!0):r&&(p=r,l=o),t()},-1)},-1)},debugBuildWorker,!0)});var f=new ExportTaskManager,c=[];u.task("parse-assets",["build-assets"],function(e){var t=Path.join(a,ImportsDestDir,"??/*");Globby(t,{nodir:!0},function(t,r){if(t)return e(t);for(var s=0;s<r.length;s++){var a=r[s],n=Path.basenameNoExt(a),u=Editor.assetdb.assetInfoByUuid(n);if(u){var d=AssetSettings[u.type];if(d&&d.exportRaw)o(n),d.exportMetaIfExportRaw&&c.push(n);else{var p=u.path,l="";if(u.isSubAsset){var b=Path.dirname(p),E=Path.basenameNoExt(b),g=Path.basename(p);if(E!==g){l=i(Path.stripExt(b)+"_"+g+Path.extname(b))}else l=i(b);var v=d&&d.extnameForSubAsset;v||(v=".json",Editor.warn(`export sub asset as ${v} file (${p})`)),l=replaceExtname(l,v)}else l=i(p);f.add(a,l,!1,n)}}else Editor.error("Can not get asset info of "+n)}e()})}),u.task("parse-raw-assets",["build-assets"],function(t){for(let e=0;e<p.length;e++){let t=p[e],r=Editor.assetdb.assetInfoByUuid(t);if(r)if(r.type){{let e=Editor.assets[r.type];if(e&&!cc.RawAsset.isRawAssetType(e))continue}o(t)}else Editor.error("Can not get asset type of "+t);else Editor.error("Can not get asset info of "+t)}for(let t in l){let r=l[t];if("cc.Texture2D"===r[1]){let s=r[0],i=Path.resolve(a,Path.join("raw-assets",s)),o=Path.resolve(e,Path.join("assets",s));f.add(i,o,!0,t)}else Editor.error(`Unknown asset in packedAutoAtlasAssets to copy: ${r}`)}t()});var b=/{\s*"__uuid__": ?"([^"]+)"\s*}/g,E=/(\B")_N\$(?=\w+":\s*[^\s:,}\]])/g;u.task("export-(raw-)assets",["parse-assets","parse-raw-assets"],function(t){for(var r=0;r<c.length;r++){var i=c[r],o=f.uuidToTask[i];f.add(o.src+".meta",o.dest+".meta",!0)}Async.forEachOfLimit(f.destToTask,IO_CONCURRENCY,(t,r,i)=>{var o;if(t.uuid){var a=Editor.assetdb.assetInfoByUuid(t.uuid);if(a){var n=AssetSettings[a.type];o=n&&n.customUuidParser}}t.isRaw&&!o?Fs.copy(t.src,t.dest,e=>{if(e)return s(e);i()}):Fs.readFile(t.src,"utf8",(r,a)=>{if(r)return s(r);a=(o||function(e,t,r,s){return e.replace(b,function(e,t){var i=r[t]||r[Editor.Utils.UuidUtils.decompressUuid(t)];if(i){var o=i.dest;return o=Path.relative(s,o),Editor.isWin32&&(o=o.replace(/\\/g,"/")),JSON.stringify(o)}return console.log("can not parse uuid",t),e})})(a,t.uuid,f.uuidToTask,e),t.isRaw||(a=function(e){return e.replace(E,"$1")}(a)),Fs.ensureDir(Path.dirname(t.dest),e=>{if(e)return s(e);Fs.writeFile(t.dest,a,e=>{if(e)return s(e);i()})})})},t)}),u.task("delete-temp",function(e){var t=[a];Editor.log("Delete "+t),Del(t,{force:!0},e)}),u.task("export",d("clean","export-(raw-)assets","delete-temp")),u.start("export",r)}const Path=require("fire-path"),Fs=require("fire-fs"),ipcMain=require("electron").ipcMain,Async=require("async"),_=require("lodash"),Globby=require("globby"),Gulp=require("gulp").Gulp,GulpSequence=require("gulp-sequence"),Del=require("del"),AssetSettings=require("./asset-settings"),ExportTaskManager=require("./export-task-manager"),debugBuildWorker=!1,debugSkipRebuild=!1,ImportsDestDir="import",BUILD_PLATFORM="export",IO_CONCURRENCY=4;exports.export=function(e,t,r){"function"==typeof t&&(r=t,t=void 0),e=Path.resolve(e),t=t||{},Editor.info(`starting export to ${e}`),runExport(e,t,e=>{e||Editor.info("finished export"),r&&r(e)})},exports._rapidTest=function(){const e=Editor.require("app://editor/builtin/project-exporter/core/exporter");let t=Path.join(Editor.projectInfo.path,"export");e.export(t,e=>{e&&Editor.error(e)})};