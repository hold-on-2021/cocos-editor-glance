(function(){"use strict";const e=require("electron"),n=(require("fire-url"),require("fire-fs"));Editor.polymerPanel("scene",{behaviors:[Editor.UI.Droppable],hostAttributes:{droppable:"asset"},listeners:{"drop-area-enter":"_onDropAreaEnter","drop-area-leave":"_onDropAreaLeave","drop-area-accept":"_onDropAreaAccept","drop-area-move":"_onDropAreaMove","engine-ready":"_onEngineReady","scene-view-ready":"_onSceneViewReady","scene-view-init-error":"_onSceneViewInitError","panel-show":"_onPanelResize","panel-resize":"_onPanelResize","panel-copy":"_onPanelCopy","panel-paste":"_onPanelPaste"},properties:{itemPath:{type:String,default:""},selection:{type:Array,default:function(){return[]}}},created:function(){this._viewReady=!1,this._ipcList=[],this._copyingIds=null,this._pastingId="",this._ensureClose=!1,this._resetLayoutInfo=null,console.time("scene:reloading"),Editor.Ipc.sendToAll("scene:reloading")},run:function(e){if(!e||!e.uuid)return;this.confirmCloseScene(()=>{this._loadScene(e.uuid)})},ready:function(){this.selection=[],this.multi=!0,this._initDroppable(this.$.dropArea),_Scene.init(),Polymer.dom(this.$.border).insertBefore(_Scene.view,this.$.loader),this.$.sceneView=_Scene.view,this.$.sceneView.init(),e.ipcRenderer.on("editor:panel-undock",e=>{"scene"===e&&_Scene.EngineEvents.unregister()})},close:function(){if(!this._ensureClose){let n=e.ipcRenderer.sendSync("app:is-main-window-attemp-to-close");this.confirmCloseScene(()=>{this._clearSelection(),this._ensureClose=!0;var e=Editor.remote.Panel.findWindow("scene");n?e.nativeWin.close():this._resetLayoutInfo?Editor.Ipc.sendToMainWin("editor:reset-layout",this._resetLayoutInfo):e.nativeWin.reload()})}return!!this._ensureClose},_clearSelection:function(){Editor.Selection.clear("node"),_Scene.unselect(this.selection),this.selection=[]},_loadSceneScript:function(e,t){let i=Editor.url(t);if(!n.existsSync(i))return Editor.error(`Package [${e}] scene script [${t}] not exists.`),void 0;let c;try{c=require(i)}catch(e){return Editor.error(e),void 0}this._sceneScripts[e]={path:i,messages:[]};for(let n in c){let t=c[n];if("function"!=typeof t)return Editor.warn(`[${n}] in package [${e}] is not a function.`),void 0;let i=`${e}:${n}`;this.messages[i]=t.bind(c),this._sceneScripts[e].messages.push(i)}},_unloadSceneScript:function(e){let n=this._sceneScripts[e].messages;for(let e=0;e<n.length;e++){let t=n[e];delete this.messages[t]}delete _Scene.Sandbox.getElectronRequire().cache[this._sceneScripts[e].path],delete this._sceneScripts[e]},_loadSceneScripts:function(){this._sceneScripts={};for(let e in Editor.sceneScripts){let n=Editor.sceneScripts[e];this._loadSceneScript(e,n)}},_onPanelResize:function(){this._resizeDebounceID||(this._resizeDebounceID=setTimeout(()=>{this._resizeDebounceID=null,_Scene.view._resize()},10))},deleteCurrentSelected:function(e){e&&e.stopPropagation();let n=Editor.Selection.curSelection("node");_Scene.deleteNodes(n)},duplicateCurrentSelected:function(e){e&&e.stopPropagation();let n=Editor.Selection.curSelection("node");_Scene.duplicateNodes(n)},confirmCloseScene:function(e){_Scene.PrefabUtils.confirmEditingPrefabSynced(),_Scene.EditMode.close(e)},_onPanelCopy:function(){let e=Editor.Selection.curSelection("node");_Scene.copyNodes(e)},_onPanelPaste:function(){let e=Editor.Selection.curActivate("node");_Scene.pasteNodes(e)},_onDropAreaEnter:function(e){e.stopPropagation()},_onDropAreaLeave:function(e){e.stopPropagation()},_onDropAreaAccept:function(e){e.stopPropagation();let n=e.detail.dragOptions.unlinkPrefab,t=e.detail.dragItems.map(e=>e.id),i=e.detail.offsetX,c=e.detail.offsetY;_Scene.createNodesAt(t,i,c,{unlinkPrefab:n})},_onDropAreaMove:function(e){if(_Scene.AnimUtils._recording)return Editor.UI.DragDrop.updateDropEffect(e.detail.dataTransfer,"none"),void 0;Editor.UI.DragDrop.updateDropEffect(e.detail.dataTransfer,"copy")},_onEngineReady:function(){_Scene.EngineEvents.register()},_onSceneViewReady:function(){this._loadSceneScripts(),this._viewReady=!0,this.$.loader.hidden=!0,_Scene.Undo.clear(),Editor.Ipc.sendToAll("scene:ready"),console.timeEnd("scene:reloading")},_onSceneViewInitError:function(e){let n=e.detail;Editor.failed(`Failed to init scene: ${n.stack}`),this.$.loader.hidden=!0},_loadScene(e){_Scene.isLoadingScene=!0,Editor.Ipc.sendToAll("scene:reloading"),this.$.loader.hidden=!1,_Scene.loadSceneByUuid(e,e=>{if(_Scene.isLoadingScene=!1,e)return this.fire("scene-view-init-error",e),void 0;this.fire("scene-view-ready")})},_newScene(){this.$.loader.hidden=!1,Editor.Ipc.sendToAll("scene:reloading"),_Scene.newScene(()=>{this.fire("scene-view-ready"),_Scene._applyCanvasPreferences()})},_onAlignTop(){_Scene.alignSelection("top")},_onAlignVCenter(){_Scene.alignSelection("v-center")},_onAlignBottom(){_Scene.alignSelection("bottom")},_onAlignLeft(){_Scene.alignSelection("left")},_onAlignHCenter(){_Scene.alignSelection("h-center")},_onAlignRight(){_Scene.alignSelection("right")},_alignValid:e=>e.length>=2,_onDistributeTop(){_Scene.distributeSelection("top")},_onDistributeVCenter(){_Scene.distributeSelection("v-center")},_onDistributeBottom(){_Scene.distributeSelection("bottom")},_onDistributeLeft(){_Scene.distributeSelection("left")},_onDistributeHCenter(){_Scene.distributeSelection("h-center")},_onDistributeRight(){_Scene.distributeSelection("right")},_distributeValid:e=>e.length>=3,messages:{"editor:reset-layout":function(e,n){this._resetLayoutInfo=n},"editor:dragstart":function(){this.$.dropArea.hidden=!1},"editor:dragend":function(){this.$.dropArea.hidden=!0},"editor:project-profile-updated":function(e,n){_Scene.projectProfileUpdated(n)},"scene:load-package-scene-script":function(e,n,t){this._loadSceneScript(n,t)},"scene:unload-package-scene-script":function(e,n){this._unloadSceneScript(n)},"scene:query-group-list":function(e){e.reply&&e.reply(null,cc.game.groupList)},"scene:is-ready":function(e){e.reply(null,this._viewReady)},"scene:new-scene":function(){this.confirmCloseScene(()=>{this._newScene()})},"scene:play-on-device":function(){_Scene.stashScene(()=>{Editor.Ipc.sendToMain("app:play-on-device")})},"scene:reload-on-device":function(){_Scene.stashScene(()=>{Editor.Ipc.sendToMain("app:reload-on-device")})},"scene:preview-server-scene-stashed":function(){_Scene.stashScene(()=>{Editor.Ipc.sendToMain("app:preview-server-scene-stashed")})},"scene:query-hierarchy":function(e){if(!cc.engine.isInitialized)return e.reply(null,"",[]),void 0;let n=_Scene.dumpHierarchy(),t=_Scene.currentScene().uuid;e.reply(null,t,n)},"scene:query-nodes-by-comp-name":function(e,n){let t=cc.director.getScene(),i=[],c=cc.js.getClassByName(n);c&&_Scene.walk(t,!1,e=>{e.getComponent(c)&&i.push(e.uuid)}),e.reply(null,i)},"scene:query-node":function(e,n,t){if(e.reply){let t=_Scene.dumpNode(n);return t=JSON.stringify(t),e.reply(null,t),void 0}let i=_Scene.dumpNode(t);i=JSON.stringify(i),Editor.Ipc.sendToWins("scene:reply-query-node",n,i)},"scene:query-node-info":function(e,n,t){let i=null,c=cc.engine.getInstanceById(n);c&&(i=c instanceof cc.Component?c.node:c);let o=null;i&&"cc.Node"!==t&&(o=i.getComponent(cc.js._getClassById(t))),e.reply(null,{name:i?i.name:"",missed:null===c,nodeID:i?i.uuid:null,compID:o?o.uuid:null})},"scene:query-node-functions":function(e,n){var t=cc.engine.getInstanceById(n),i=Editor.getNodeFunctions(t);e.reply(null,i)},"scene:query-animation-node":function(e,n){var t=_Scene.AnimUtils.getAnimationNodeDump(n);e.reply(null,t)},"scene:is-child-class-of":function(e,n,t){let i=cc.js._getClassById(n),c=cc.js._getClassById(t),o=cc.isChildClassOf(i,c);e.reply(null,o)},"scene:reset-node":function(e,n){let t=cc.engine.getInstanceById(n);t&&(_Scene.Undo.recordNode(t.uuid,"Reset Node"),_Scene.resetNode(t),_Scene.Undo.commit())},"scene:reset-all":function(e,n){let t=cc.engine.getInstanceById(n);if(t){_Scene.Undo.recordNode(t.uuid,"Reset All"),_Scene.resetNode(t);for(var i=0;i<t._components.length;++i)_Scene.resetComponent(t._components[i]);_Scene.Undo.commit()}},"scene:new-property":function(e,n){_Scene.newProperty(n.id,n.path,n.type)},"scene:reset-property":function(e,n){_Scene.resetProperty(n.id,n.path,n.type)},"scene:set-property":function(e,n){_Scene.setProperty(n);let t=cc.engine.getInstanceById(n.id);setTimeout(()=>{Editor.Ipc.sendToAll("scene:node-component-updated",{node:t.node?t.node.uuid:t.id,component:t.node?n.id:null,property:t.path,value:n.value})},100)},"scene:has-copied-component":function(e){let n=!1;_Scene.clipboard.data instanceof cc.Component&&(n=!0),e.reply(null,n)},"scene:add-component":function(e,n,t){Editor.Ipc.sendToMain("metrics:track-event",{category:"Scene",action:"Component Add",label:t}),_Scene.addComponent(n,t),Editor.Ipc.sendToAll("scene:node-component-added",{node:n,component:t})},"scene:remove-component":function(e,n,t){_Scene.removeComponent(n,t),Editor.Ipc.sendToAll("scene:node-component-removed",{node:n,component:t})},"scene:move-up-component":function(e,n,t){let i=cc.engine.getInstanceById(n),c=cc.engine.getInstanceById(t);if(!i||!c)return;let o=i._components.indexOf(c);if(o<=0)return;let r=o-1;i._components.splice(o,1),i._components.splice(r,0,c)},"scene:move-down-component":function(e,n,t){let i=cc.engine.getInstanceById(n),c=cc.engine.getInstanceById(t);if(!i||!c)return;let o=i._components.indexOf(c);if(o>=i._components.length)return;let r=o+1;i._components.splice(o,1),i._components.splice(r,0,c)},"scene:reset-component":function(e,n,t){let i=cc.engine.getInstanceById(t);i&&(_Scene.Undo.recordNode(n,"Reset Component"),_Scene.resetComponent(i),_Scene.Undo.commit())},"scene:copy-component":function(e,n){_Scene.copyComponent(n)},"scene:paste-component":function(e,n,t){_Scene.pasteComponent(n,t)},"scene:create-nodes-by-uuids":function(e,n,t,i){_Scene.createNodes(n,t,i)},"scene:create-node-by-classid":function(e,n,t,i,c){Editor.Ipc.sendToMain("metrics:track-event",{category:"Scene",action:"Node Prefab Add",label:"Empty"}),_Scene.createNodeByClassID(n,t,i,c)},"scene:create-node-by-prefab":function(e,n,t,i,c){Editor.Ipc.sendToMain("metrics:track-event",{category:"Scene",action:"Node Prefab Add",label:n.replace("New ","")}),_Scene.createNodeByPrefab(n,t,i,c)},"scene:move-nodes":function(e,n,t,i){_Scene.moveNodes(n,t,i)},"scene:delete-nodes":function(e,n){_Scene.deleteNodes(n)},"scene:copy-nodes":function(e,n){_Scene.copyNodes(n)},"scene:paste-nodes":function(e,n){_Scene.pasteNodes(n)},"scene:duplicate-nodes":function(e,n){_Scene.duplicateNodes(n)},"scene:stash-and-reload":function(){_Scene.stashScene(()=>{this.reload()})},"scene:soft-reload":function(e,n){_Scene.softReload(n)},"scene:center-nodes":function(e,n){_Scene.ajustSceneToNodes(n)},"scene:create-prefab":function(e,n,t){_Scene.createPrefab(n,t)},"scene:apply-prefab":function(e,n){_Scene.applyPrefab(n)},"scene:revert-prefab":function(e,n){_Scene.revertPrefab(n)},"scene:set-prefab-sync"(e,n){_Scene.setPrefabSync(n)},"scene:break-prefab-instance":function(){let e=Editor.Selection.curSelection("node");_Scene.breakPrefabInstance(e)},"scene:link-prefab":function(){_Scene.linkPrefab()},"scene:enter-prefab-edit-mode":function(e,n){_Scene.EditMode.push("prefab",n)},"scene:stash-and-save":function(){_Scene.EditMode.save()},"scene:saved":function(){_Scene.Undo.save()},"scene:undo":function(){_Scene.Undo.commit(),_Scene.Undo.undo()},"scene:redo":function(){_Scene.Undo.redo()},"scene:undo-record":function(e,n,t){_Scene.Undo.recordObject(n,t)},"scene:undo-commit":function(){_Scene.Undo.commit()},"scene:undo-cancel":function(){_Scene.Undo.cancel()},"scene:animation-state-changed":function(e,n){_Scene.AnimUtils.setCurrentPlayState(n)},"scene:query-animation-time":function(e,n){var t=_Scene.AnimUtils.getAnimationTime(n);e.reply(null,t)},"scene:animation-time-changed":function(e,n){_Scene.AnimUtils.setAnimationTime(n)},"scene:animation-clip-changed":function(e,n){_Scene.AnimUtils.updateClip(n)},"scene:new-clip":function(e,n){_Scene.AnimUtils.addClip(n)},"scene:animation-current-clip-changed":function(e,n){_Scene.AnimUtils.changeCurrentClip(n)},"scene:save-clip":function(){_Scene.EditMode.save()},"scene:set-animation-speed":function(e,n){_Scene.AnimUtils.setSpeed(n)},"scene:export-particle-plist":function(e,n){_Scene.PariticleUtils.exportParticlePlist(n)},"scene:print-simulator-log":function(e,n){_Scene.printSimulatorLog(n)},"scene:exchange-scene-spriteframes":function(e){_Scene.SpriteframeUtils.exchangeSceneSpriteFrames()},"scene:exchange-animation-clip-spriteframes":function(e){_Scene.SpriteframeUtils.exchangeAnimationClipSpriteFrames()},"scene:generate-texture-packer-preview-files":function(e,n){Editor.require("app://editor/page/build/texture-packer").generatePreviewFiles(n,n=>{e.reply?e.reply(n):n&&Editor.error(n)})},"scene:query-texture-packer-preview-files":function(e,n){Editor.require("app://editor/page/build/texture-packer").queryPreviewInfo(n,(n,t)=>{e.reply?e.reply(n,t):n&&Editor.error(n)})},"scene:query-dirty-state":function(e){if(e.reply){let n=_Scene.EditMode._modeStack;if(n.length>0)for(let t=n.length-1;t>=0;t--){let i=n[t];if(i.dirty())return e.reply(null,{dirty:!0,name:i.name}),void 0}e.reply(null,{name:"scene",dirty:_Scene.Undo.dirty()})}},"scene:regenerate-polygon-points":function(e,n){var t=cc.engine.getInstanceById(n);t&&t.resetPointsByContour&&t.resetPointsByContour()},"scene:choose-last-rigid-body":function(e,n){var t=cc.engine.getInstanceById(n);if(t instanceof cc.Joint){var i=t.node.getSiblingIndex()-1;i<0&&(i=t.node.parent.children.length-1);var c=t.node.parent.children[i];if(!c)return;_Scene.Undo.recordNode(t.node.uuid),t.connectedBody=c.getComponent(cc.RigidBody),_Scene.Undo.commit()}},"scene:choose-next-rigid-body":function(e,n){var t=cc.engine.getInstanceById(n);if(t instanceof cc.Joint){var i=t.node.getSiblingIndex()+1;i>=t.node.parent.children.length&&(i=0);var c=t.node.parent.children[i];c||(c=t.node.parent),_Scene.Undo.recordNode(t.node.uuid),t.connectedBody=c.getComponent(cc.RigidBody),_Scene.Undo.commit()}},"selection:selected":function(e,n,t){"node"===n&&(_Scene.select(t),this.selection=Editor.Selection.curSelection("node"))},"selection:unselected":function(e,n,t){"node"===n&&(_Scene.unselect(t),this.selection=Editor.Selection.curSelection("node"))},"selection:activated":function(e,n,t){if("node"!==n||!t)return;_Scene.activate(t);let i=cc.engine.getInstanceById(t);this.itemPath=i?_Scene.NodeUtils.getNodePath(i):""},"selection:deactivated":function(e,n,t){"node"===n&&_Scene.deactivate(t)},"selection:hoverin":function(e,n,t){"node"===n&&_Scene.hoverin(t)},"selection:hoverout":function(e,n,t){"node"===n&&_Scene.hoverout(t)},"asset-db:asset-changed":function(e,n){_Scene.assetChanged(n)},"asset-db:assets-moved":function(e,n){_Scene.assetsMoved(n)},"scene:query-animation-hierarchy"(e,n){let t=cc.engine.getInstanceById(n),i=t;for(;i&&!i.getComponent(cc.Animation);){if(i.parent instanceof cc.Scene){i=t;break}i=i.parent}e.reply&&e.reply(null,JSON.stringify(_Scene.dumpHierarchy(i,!0)))},"scene:query-animation-list"(e,n){let t=cc.engine.getInstanceById(n);if(!t||t instanceof cc.Scene)return e.reply&&e.reply(null,[]),void 0;let i=t.getComponent(cc.Animation);if(!i)return e.reply&&e.reply(null,[]),void 0;let c=i.getClips(),o=(c=c.filter(function(e){return!!e})).map(e=>e._uuid);e.reply&&e.reply(null,o)},"scene:query-animation-properties"(e,n){let t=cc.engine.getInstanceById(n),i=t;for(;i&&!i.getComponent(cc.Animation);){if(i.parent instanceof cc.Scene){i=t;break}i=i.parent}Editor.require("app://editor/page/scene-utils/dump/get-animation-node-dump.js");let c=Editor.getAnimationProperties(Editor.getNodeDump(t),i!==t);e.reply&&e.reply(null,c)},"scene:query-animation-record"(e){let n=_Scene.EditMode.curMode(),t=_Scene.AnimUtils.curRootNode,i=_Scene.AnimUtils.getCurrentClip(),c={record:n&&"animation"===n.name,root:t?t.uuid:"",clip:i?{id:i._uuid,name:i.name}:null};e.reply&&e.reply(null,c)},"scene:query-animation-clip"(e,n){if(!_Scene.AnimUtils.curAnim)return e.reply&&e.reply(null,null);let t=_Scene.AnimUtils.curAnim.getClips();for(let i=0;i<t.length;i++){let c=t[i];if(c._uuid===n)return e.reply&&e.reply(null,Editor.serialize(c))}e.reply&&e.reply(null,null)},"scene:change-animation-record"(e,n){n?_Scene.EditMode.push("animation"):_Scene.EditMode.pop("animation")}}})})();