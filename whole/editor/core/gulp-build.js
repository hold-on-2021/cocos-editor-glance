function getTemplateFillPipe(e){return Es.through(function(t){if(".html"===Path.extname(t.path)){Winston.normal("Generating html from "+t.path);var i=e.webOrientation;"auto"===i&&(i="");const r=Editor.url("app://node_modules/eruda/eruda.min.js"),n=`<script src="${Path.basename(r)}"><\/script>`;var s={file:t,project:e.projectName||Path.basename(e.project),previewWidth:e.previewWidth,previewHeight:e.previewHeight,orientation:i,eruda:e.includeEruda?n:""};t.contents=new Buffer(Gutil.template(t.contents,s))}else if("main.js"===Path.basename(t.path)){Winston.normal("Generating main.js from "+t.path);let i="qqplay"===e.platform;if(i&&e.qqplay&&e.qqplay.REMOTE_SERVER_ROOT){let i='qqPlayDownloader.REMOTE_SERVER_ROOT = "'+e.qqplay.REMOTE_SERVER_ROOT+'"',s=t.contents.toString();s=s.replace(/qqPlayDownloader.REMOTE_SERVER_ROOT = ""/g,i),t.contents=new Buffer(s)}s={file:t,renderMode:e.renderMode,isWeChatGame:"wechatgame"===e.platform,isWeChatSubdomain:e.wechatgame&&e.wechatgame.isSubdomain||!1,isQQPlay:i,engineCode:"",projectCode:""};if(i){var r=e.debug;s.engineCode=r?"'GameRes://cocos2d-js.js'":"'GameRes://cocos2d-js-min.js'",s.projectCode=r?"'GameRes://src/project.dev.js'":"'GameRes://src/project.js'"}t.contents=new Buffer(Gutil.template(t.contents,s))}this.emit("data",t)})}function stringifySettings(e,t){var i=JSON.stringify(e,null,t?4:0).replace(/"([A-Za-z_$][0-9A-Za-z_$]*)":/gm,"$1:");return i=t?`${CCSETTINGS_PREFIX} = ${i};\n`:`${CCSETTINGS_PREFIX}=${i};`,i}function buildSettings(e,t){function i(e,t,i,s){if(!e)return console.error("can not get url to build: "+t),null;if(!e.startsWith(DB_PROTOCOL_HEADER))return console.error("unknown url to build: "+e),null;var r=Editor.assetdb.isSubAssetByUuid(t);if(r){var n=Url.dirname(e),a=Url.extname(n);a&&(n=n.slice(0,-a.length)),e=n}var o=e.indexOf("/",DB_PROTOCOL_HEADER.length);if(o<0)return console.error("no mount to build: "+e),null;var l=e.slice(DB_PROTOCOL_HEADER.length,o);if(!l)return console.error("unknown mount to build: "+e),null;var c=e.slice(o+1);return c?("audio-clip"===i&&(s||(s=Editor.assetdb.loadMetaByUuid(t)),s&&"1"==s.downloadMode&&(c+="?useDom=1")),{mountPoint:l,relative:c,uuid:t,isSubAsset:r}):(console.error("unknown relative to build: "+e),null)}var s=e.customSettings,r=e.debug,n={},a={},o=!e.preview,l=Editor.assetdb,c=Editor.assets,u=Editor.Utils.UuidUtils.compressUuid;console.time("queryAssets"),function(e,t){var r=PlatfomSettigns[s.platform].isNative;if(e){for(var n=[],a=0,o=e.length;a<o;a++){var u=e[a],d=l.uuidToUrl(u),p=l.assetInfoByUuid(u);if(p){var m=p.type;if(m){var f=i(d,u,m);if(!f)continue;var g=c[m];f.ctor=g||cc.RawAsset,n.push(f)}else console.error("Can not get asset type of "+u)}else console.error("Can not get asset info of "+u)}l.queryMetas("db://**/*","javascript",function(e,i){var s;s=r?e=>e.isPlugin&&e.loadPluginInNative:e=>e.isPlugin&&e.loadPluginInWeb;var a=i.filter(s).map(e=>e.uuid);t(null,n,a)})}else console.time("queryMetas"),l.queryMetas("db://**/*","",function(e,s){console.timeEnd("queryMetas");for(var n=[],a=[],o=0,u=s.length;o<u;o++){var d=s[o],p=d.assetType();if("folder"!==p){"javascript"===p&&d.isPlugin&&(r?d.loadPluginInNative&&a.push(d.uuid):d.loadPluginInWeb&&a.push(d.uuid));var m=d.uuid,f=i(l.uuidToUrl(m),m,p,d);if(f&&(f.relative.startsWith("resources/")||d.useRawfile())){var g=c[p];f.ctor=g||cc.RawAsset,n.push(f)}}}t(e,n,a)})}(e.uuidList,function(i,c,d){if(console.timeEnd("queryAssets"),i)return t(i);(function(e,t,i){var s,a=cc.RawAsset,l=e.rawAssets={assets:{}};r||(s=e.assetTypes=[]);for(var c={},d=0,p=(t=_.sortBy(t,"relative")).length;d<p;d++){var m=t[d],f=m.mountPoint;if(!m.ctor||a.isRawAssetType(m.ctor)){if(m.ctor!==cc.ParticleAsset){var g=n[f];g?g.push(m.uuid):n[f]=[m.uuid]}}else if(!m.relative.startsWith("resources/"))continue;var h=l[f];h||(h=l[f]={});var b=cc.js._getClassId(m.ctor,!1);if(!r){var v=c[b];void 0===v&&(s.push(b),v=s.length-1,c[b]=v),b=v}var j;j=m.isSubAsset?[m.relative,b,1]:[m.relative,b];let e=m.uuid;o&&(e=u(e,!0)),h[e]=j}for(let e in i){var E=e;o&&(E=u(e,!0)),l.assets[E]=i[e]}})(s,c,e.packedAutoAtlasAssets),function(e,t){for(var i=[],s=0;s<t.length;s++){var r=t[s],n=l.uuidToUrl(r);n=n.slice(DB_PROTOCOL_HEADER.length),a[n]=r,i.push(n)}i.sort(),i.length>0&&(e.jsList=i)}(s,d),e.sceneList.length>0&&(s.launchScene=Editor.assetdb.uuidToUrl(e.sceneList[0])),function(e,t){t=t.map(e=>{var t=Editor.assetdb.uuidToUrl(e);return t?(o&&(e=u(e,!0)),{url:t,uuid:e}):(Editor.warn(`Can not get url of scene ${e}, it maybe deleted.`),null)}).filter(Boolean),e.scenes=t}(s,e.sceneList),function(e,t){if(o&&t){var i={};for(var s in t){var r=t[s];i[s]=r.map(e=>u(e,!0))}t=i}e.packedAssets=t||void 0}(s,e.packedAssets),s.orientation=e.webOrientation,r&&(s.debug=!0),r||function(e){let t={};(function(){function i(e){var i=(r[e]||0)+1;r[e]=i,i>=2&&!(e in t)&&(t[e]=s.length,s.push(e))}let s=e.uuids=[],r={},n=e.rawAssets;for(let e in n){let t=n[e];for(let e in t)i(e)}let a=e.scenes;for(let e=0;e<a.length;++e)i(a[e].uuid);let o=e.packedAssets;for(let e in o)o[e].forEach(i)})();let i=e.rawAssets,s=e.rawAssets={};for(let e in i){let n=i[e],a=s[e]={};for(let e in n){var r=n[e];let i=t[e];void 0!==i&&(e=i),a[e]=r}}let n=e.scenes;for(let e=0;e<n.length;++e){let i=n[e],s=t[i.uuid];void 0!==s&&(i.uuid=s)}let a=e.packedAssets;for(let e in a){let i=a[e];for(let e=0;e<i.length;++e){let s=t[i[e]];void 0!==s&&(i[e]=s)}}}(s);(!("stringify"in e)||e.stringify)&&(s=stringifySettings(s,r)),t(null,s,n,a)})}const Path=require("fire-path"),Url=require("fire-url"),Fs=require("fire-fs"),Format=require("util").format,ipcMain=require("electron").ipcMain,Globby=require("globby"),Gulp=require("gulp").Gulp,Rename=require("gulp-rename"),Gutil=require("gulp-util"),Es=require("event-stream"),Uglify=require("gulp-uglify"),Combiner=require("stream-combiner2"),GulpSequence=require("gulp-sequence"),RevAll=require("gulp-rev-all"),RevDel=require("gulp-rev-delete-original"),Del=require("del"),Async=require("async"),_=require("lodash"),Winston=require("winston"),crypto=require("crypto"),Compiler=require("./compiler"),NativeUtils=require("./native-utils"),PlatfomSettigns=require("../share/build-platforms"),BUILD_="build-platform_",RAW_ASSET_DEST_PREFIX="raw-",DB_PROTOCOL_HEADER="db://",CCSETTINGS_PREFIX="window._CCSettings",HASH_LEN=5;exports.startWithArgs=function(e,t){function i(e){n.isRunning?n.stop(e):Editor.error(e)}function s(t,i){var s=[h.template_shares,t];return n.src(s).pipe(getTemplateFillPipe(e)).pipe(n.dest(d)).on("end",i)}function r(e){var t=Path.basename(e),i=Path.dirname(e),s=Path.join(i,t);const r=Fs.readFileSync(s);var n=crypto.createHash("md5").update(r).digest("hex");n=n.slice(0,HASH_LEN);var a=t.lastIndexOf("."),o=~a?`${t.slice(0,a)}.${n}${t.slice(a)}`:`${t}.${n}`,l=Path.join(i,o);try{Fs.renameSync(s,l)}catch(e){Gutil.log(`[31m[MD5 ASSETS] write file error: ${e.message}[0m`)}return{hash:n,path:l}}var n=new Gulp,a=GulpSequence.use(n),o=e.project,l=e.projectName||Path.basename(o),c=e.platform;if(e.wechatgame.isSubdomain){let t=Path.dirname(e.dest);e.dest=Path.join(t,l)}var u,d=e.dest,p=!!e.debug,m=e.sourceMaps;e.renderMode;"qqplay"===c?u=e.qqplay.orientation:"auto"===(u=e.webOrientation)&&(u="");var f=e.debugBuildWorker,g=PlatfomSettigns[c].isNative;if(Editor.log("Building "+o),Editor.log("Destination "+d),Path.normalize(d)===Path.normalize(o))return t(new Error("Can not export project at project folder."));if(Path.contains(Editor.App.path,d))return t(new Error("Can not export project to fireball app folder."));var h={tmplBase:Path.resolve(Editor.url("unpack://static"),"build-templates"),jsCacheDir:Editor.url("unpack://engine/bin/.cache/"+c)};Object.assign(h,{template_shares:Path.join(h.tmplBase,"shares/**/*"),template_web_desktop:Path.join(h.tmplBase,p?"web-desktop/template-dev/**/*":"web-desktop/template/**/*"),template_web_mobile:Path.join(h.tmplBase,p?"web-mobile/template-dev/**/*":"web-mobile/template/**/*"),bundledScript:Path.join(d,"src",p?"project.dev.js":"project.js"),src:Path.join(d,"src"),res:Path.join(d,"res"),settings:Path.join(d,"src/settings.js"),jsCache:Path.join(h.jsCacheDir,p?g?"jsb_polyfill.dev.js":"cocos2d-js.js":g?"jsb_polyfill.js":"cocos2d-js-min.js"),jsCacheExcludes:Path.join(h.jsCacheDir,p?".excludes":".excludes-min"),erudaSrc:Editor.url("app://node_modules/eruda/eruda.min.js"),template_instant_games:Path.join(h.tmplBase,"fb-instant-games/**/*")}),n.task("compile",function(e){Editor.Ipc.sendToMain("builder:state-changed","compile",.1);var t={project:o,platform:c,dest:h.bundledScript,debug:p,sourceMaps:m};Compiler.doCompile(t,function(t){t?i(t):e()})});var b,v,j;n.task("build-assets",["compile"],function(t){function s(e,i){if(r&&!f){var s=r;r=null,s.nativeWin.destroy()}n.isRunning?t(new Error(i)):Editor.error(i)}Editor.log("Start building assets"),Editor.Ipc.sendToMain("builder:state-changed","spawn-worker",.3),b=null,v=null;var r,a="app:build-project-abort";ipcMain.once(a,s),Winston.normal("Start spawn build-worker");var o=!1;Editor.App.spawnWorker("app://editor/page/build/build-worker",function(n,l){Winston.normal("Finish spawn build-worker"),r=n;var u;o||(o=!0,l.once("closed",function(){u||(ipcMain.removeListener(a,s),Editor.log("Finish building assets"),t())})),Winston.normal("Start init build-worker"),Editor.Ipc.sendToMain("builder:state-changed","init-worker",.32),r.send("app:init-build-worker",c,p,function(t){function s(){!r||f||(r.close(),r=null)}t?(i(t),u=!0,s()):r&&(Winston.normal("Finish init build-worker"),Winston.normal("Start build-assets in worker"),Editor.Ipc.sendToMain("builder:state-changed","build-assets",.65),r.send("app:build-assets",h.res,c,p,_.pick(e,"scenes","inlineSpriteFrames","mergeStartScene","optimizeHotUpdate","wechatgame"),function(e,t,r,n){e?(i(e),u=!0):t&&(b=t,v=r,j=n),Winston.normal("Finish build-assets in worker"),s()},-1))},-1)},f,!0)});var E=null,y=null,w=null;n.task("build-settings",["build-assets"],function(t){var s=Editor.Profile.load("profile://project/project.json");buildSettings({stringify:!1,customSettings:{platform:c,groupList:s.data["group-list"],collisionMatrix:s.data["collision-matrix"]},sceneList:e.scenes,uuidList:b,packedAssets:v,webOrientation:u,debug:p,packedAutoAtlasAssets:j},function(e,s,r,n){e?i(e):(E=s,y=r,w=n,t())})}),n.task("build-web-desktop-template",function(e){s(h.template_web_desktop,e)}),n.task("build-web-mobile-template",function(e){s(h.template_web_mobile,e)}),n.task("build-fb-instant-games-template",function(e){s(h.template_instant_games,e)}),n.task("build-raw-assets",["build-settings"],function(e){Editor.log("Start building raw assets"),Editor.Ipc.sendToMain("builder:state-changed","build-raw-assets",.9),Async.forEachOfSeries(y,(e,t,s)=>{var r=Editor.assetdb.mountInfo(DB_PROTOCOL_HEADER+t).path,n=Path.join(h.res,"raw-"+t);Async.eachLimit(e,4,(e,t)=>{var s=Editor.assetdb.uuidToFspath(e),a=Path.relative(r,s),o=Path.resolve(n,a);Fs.isDir(s,e=>{if(e)return Editor.error(`Internal Error: Should not copy folder ${s} to ${o}`),t();Fs.copy(s,o,e=>{if(e)return Editor.error(`Failed to copy ${s} to ${o}`),i(e);t()})})},s)},function(t){Editor.log("Finish building raw assets"),e(t)})}),n.task("build-plugin-scripts",["build-settings"],function(){Editor.log("Start building plugin scripts");var e=Editor.assetdb,t=[];for(var s in w){var r=w[s];let c=e.uuidToFspath(r);var a=Path.dirname(Path.join(h.src,s));console.log(`start gulpping ${c} to ${a}`);var o=n.src(c);if(!p){var l=Editor.require("unpack://engine/gulp/util/utils").getUglifyOptions;o=o.pipe(Uglify(l("build",{jsb:g,debug:p})));Combiner.obj([o]).on("error",function(e){i(e.message),Editor.error(Editor.T("BUILDER.error.build_plugin_scripts_not_support_es6"))})}o=o.pipe(n.dest(a)).on("end",()=>{console.log("finish gulpping",c)}),t.push(o)}return t.length>0?Es.merge(t).on("end",()=>{Editor.log("Finish building plugin scripts")}):null}),n.task("copy-project-json",function(){var e=Path.join(h.tmplBase,"runtime/project.json"),t=JSON.parse(Fs.readFileSync(e));t.debugMode=p?1:3,t.showFPS=p;var i=Path.join(d,"project.json");Fs.ensureFileSync(i),Fs.writeFileSync(i,JSON.stringify(t,null,2))}),n.task("copy-main-js",function(){return n.src([Path.join(h.tmplBase,"shares/main.js")]).pipe(getTemplateFillPipe(e)).pipe(n.dest(d))}),n.task("import-script-statically",function(t){if("qqplay"===e.platform&&E.jsList&&E.jsList.length>0){var i=h.src,s="\n        // plugin script code\n        ";E.jsList.map(e=>{let t=Path.relative(d,Path.resolve(i,e));Editor.isWin32&&(t=t.replace(/\\/g,"/")),s+=`BK.Script.loadlib('GameRes://${t}'); \n        `});var r=Path.join(d,"main.js"),n=Fs.readFileSync(r,"utf8");s=n.replace("// <plugin script code>",s),Fs.writeFileSync(r,s),E.jsList=void 0}t()}),n.task("copy-build-template",function(t){Editor.Ipc.sendToMain("builder:state-changed","copy-build-templates",.98);let i=Path.basename(e.dest),s=Path.join(e.project,"build-templates");if(!Fs.existsSync(s))return t();let r=Path.join(s,i,"**");Globby(r,(i,r)=>{(r=r.map(e=>Path.resolve(e))).forEach(t=>{let i=Path.relative(s,t),r=Path.join(e.buildPath,i);Fs.ensureDirSync(Path.dirname(r)),Fs.copySync(t,r)}),t&&t(i)})}),n.task("build-common",["compile","build-assets","build-raw-assets","build-plugin-scripts","build-settings"]);var S=require(Editor.url("unpack://engine/gulp/tasks/engine"));n.task("build-cocos2d",function(t){function i(){var e=[h.jsCache];m&&e.push(h.jsCache+".map");var t=n.src(e);return g&&(t=t.pipe(Rename("jsb_polyfill.js"))),t=t.pipe(n.dest(s)),t}Editor.Ipc.sendToAll("builder:state-changed","cut-engine",0);var s=g?Path.join(d,"src"):d;Fs.ensureDirSync(h.jsCacheDir),e.excludedModules=e.excludedModules?e.excludedModules.sort():[];var r=!1;if(Fs.existsSync(h.jsCacheExcludes)){let t=Fs.readJSONSync(h.jsCacheExcludes);t.excludes&&t.version&&(r=Editor.versions.cocos2d===t.version&&t.excludes.toString()===e.excludedModules.toString())}if(r&&Fs.existsSync(h.jsCache))return i().on("end",t),void 0;var a=[],o=require(Editor.url("unpack://engine/modules.json"));o&&o.length>0&&e.excludedModules&&e.excludedModules.forEach(function(e){o.some(function(t){if(t.name===e)return t.entries&&t.entries.forEach(function(e){a.push(Path.join(Editor.url("unpack://engine"),e))}),!0})}),function(e,t,i){var s=g?"unpack://engine/jsb/index.js":"unpack://engine/index.js";S[p?g?"buildJsb":"buildCocosJs":g?"buildJsbMin":"buildCocosJsMin"](Editor.url(s),t,e,{wechatgame:"wechatgame"===c,qqplay:"qqplay"===c},i)}(a,h.jsCache,function(){i().on("end",()=>{Fs.writeFileSync(h.jsCacheExcludes,JSON.stringify({excludes:e.excludedModules,version:Editor.versions.cocos2d}),null,4),t()})})}),n.task("copy-eruda",function(t){var i=Path.join(d,Path.basename(h.erudaSrc));e.includeEruda?Fs.copy(h.erudaSrc,i,t):Del(i,{force:!0},t)}),n.task("revision-res-jsList",function(t){e.md5Cache&&(console.time("revision"),function(e){const t=Path.join(h.res,"**");var i=Globby.sync(t,{nodir:!0});const s={};(function(e){for(var t=0;t<i.length;++t){var n=i[t],a=r(n).hash,o=Path.relative(d,n);"win32"===process.platform&&(o=o.replace(/\\/g,"/")),o=(o=o.replace(/^res\/import\//,"")).replace(/^res\/raw-/,""),s[o]=a}e.md5AssetsMap?Object.assign(e.md5AssetsMap,s):e.md5AssetsMap=s})(e)}(E),function(e){if(e.jsList&&e.jsList.length>0){var t=h.src,i=e.jsList.map(e=>Path.resolve(t,e)).map(e=>(e=r(e).path,Path.relative(t,e).replace(/\\/g,"/")));i.sort(),e.jsList=i}}(E),console.timeEnd("revision")),t()}),n.task("save-settings",function(e){Fs.writeFile(h.settings,stringifySettings(E,p),e)}),n.task("revision-other",function(t){if(e.md5Cache){var i=["src/*.js","*"],s=d,r=["index.html"],a=[Path.relative(s,h.bundledScript)];"wechatgame"===c?(r=r.concat(["game.js","game.json","project.config.json","index.js"]),a=a.concat(["game.json","project.config.json"])):"qqplay"===c&&(r=r.concat(["main.js","cocos2d-js.js","cocos2d-js-min.js","project.dev.js","project.js","settings.js"])),Editor.isWin32&&(a=a.map(e=>e.replace(/\\/g,"/"))),n.src(i,{cwd:d,base:s}).pipe(RevAll.revision({debug:!0,hashLength:HASH_LEN,dontRenameFile:r,dontSearchFile:a,annotator:function(e,t){return[{contents:e,path:t}]},replacer:function(e,t,i,s){".map"===Path.extname(e.path)&&s.revPathOriginal+".map"!==e.path||(e.contents=e.contents.replace(t,"$1"+i+"$3$4"))}})).pipe(RevDel()).pipe(n.dest(d)).on("end",t)}else t()}),n.task("finish-build",a("copy-build-template","import-script-statically","before-change-files","save-settings","revision-other")),n.task("pack-wechatgame-subdomain",function(t){if(e.wechatgame.isSubdomain){(function(e){const t=Editor.require("app://editor/share/engine-extends/json-packer");let i=Globby.sync(Path.join(h.res,"import/**"),{nodir:!0}),s=new t;for(let e=0;e<i.length;++e){let t=i[e],r=Path.extname(t);if(".json"!==r)continue;let n=Fs.readFileSync(t,{encoding:"utf8"}),a=Path.basename(t,r),o=(0,Editor.Utils.UuidUtils.compressUuid)(a,!0);s.add(o,JSON.parse(n.toString())),Del.sync(t,{force:!0})}let r=s.pack();e.packedAssets={WECHAT_SUBDOMAIN:r.indices},e.WECHAT_SUBDOMAIN_DATA=JSON.parse(r.data)})(E),Del.sync(Path.join(d,"game.json"),{force:!0}),Del.sync(Path.join(d,"project.config.json"),{force:!0});let e=Path.join(d,"game.js"),t=Fs.readFileSync(e,"utf8"),i='SUBCONTEXT_ROOT = "'+l+'"';t=t.replace(/SUBCONTEXT_ROOT = ""/g,i),t+="\nrequire('libs/sub-context-adapter');",Fs.writeFileSync(Path.join(d,"index.js"),t),Del.sync(e,{force:!0})}else Del.sync(Path.join(d,"libs/sub-context-adapter.js"),{force:!0});t()}),n.task("copy-wechatgame-files",function(){var t=Editor.url("packages://weapp-adapter/wechatgame/libs/weapp-adapter/"),i=[Editor.url("packages://weapp-adapter/wechatgame/**/*")];return n.src(i).pipe(Es.through(function(i){var s=Path.basename(i.path),r=Path.contains(t,i.path);if("game.js"===s){var n=i.contents.toString(),a='REMOTE_SERVER_ROOT = "'+e.wechatgame.REMOTE_SERVER_ROOT+'"';n=n.replace(/REMOTE_SERVER_ROOT = ""/g,a),i.contents=new Buffer(n)}else if("game.json"===s){let t=JSON.parse(i.contents.toString());t.deviceOrientation=e.wechatgame.orientation,t.openDataContext=e.wechatgame.isSubdomain?"":e.wechatgame.subContext,i.contents=new Buffer(JSON.stringify(t,null,4))}else if("project.config.json"===s){let t=JSON.parse(i.contents.toString());t.appid=e.wechatgame.appid||"wx6ac3f5090a6b99c5",t.projectname=l,i.contents=new Buffer(JSON.stringify(t,null,4))}else if(".js"===Path.extname(s)&&r){var o;try{o=require("babel-core").transform(i.contents.toString(),{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:i.path,presets:["env"],plugins:["transform-decorators-legacy","transform-class-properties","transform-export-extensions","add-module-exports"]})}catch(e){return e.stack=`Compile ${s} error: ${e.stack}`,this.emit("error",e)}i.contents=new Buffer(o.code)}this.emit("data",i)})).pipe(n.dest(d))}),n.task("copy-qqplay-files",function(){var e=[Editor.url("packages://qqplay-adapter/qqplay/**/*")];return n.src(e).pipe(Es.through(function(e){this.emit("data",e)})).pipe(n.dest(d))}),n.task("before-change-files",function(t){let i=require(Editor.url("app://editor/share/build-utils"));Editor.Builder.doCustomProcess("before-change-files",i.getCommonOptions(e),t)}),n.task(BUILD_+"web-desktop",a("build-cocos2d",["build-common","copy-eruda"],["revision-res-jsList","build-web-desktop-template"],"finish-build")),n.task(BUILD_+"web-mobile",a("build-cocos2d",["build-common","copy-eruda"],["revision-res-jsList","build-web-mobile-template"],"finish-build")),n.task(BUILD_+"fb-instant-games",a("build-cocos2d",["build-common","copy-eruda"],["revision-res-jsList","build-fb-instant-games-template"],"finish-build")),n.task(BUILD_+"wechatgame",a("build-cocos2d","build-common","copy-main-js","copy-wechatgame-files","pack-wechatgame-subdomain","revision-res-jsList","finish-build")),n.task(BUILD_+"qqplay",a("build-cocos2d","build-common","copy-main-js","copy-qqplay-files","revision-res-jsList","finish-build")),n.task("copy-runtime-scripts",function(){var e=Path.join(d,"src");return n.src(Path.join(h.tmplBase,"runtime/**/*.js")).pipe(n.dest(e))}),n.task("encrypt-src-js",function(t){if(p||!e.encryptJs)return t(),void 0;var i=Path.join(d,"src"),s=Path.resolve(i,"../js backups (useful for debugging)");Fs.copy(i,s,i=>{i&&Editor.warn("Failed to backup js files for debugging.",i),NativeUtils.encryptJsFiles(e,t)})}),n.task("copy-native-files",a("build-common","copy-project-json","copy-runtime-scripts","copy-main-js","revision-res-jsList","finish-build","encrypt-src-js")),n.task("build-cocos-native-project",function(t){NativeUtils.build(e,t)}),n.task("build-native-project",a("build-cocos-native-project","build-cocos2d","copy-native-files")),n.task(BUILD_+"android",["build-native-project"]),n.task(BUILD_+"ios",["build-native-project"]),n.task(BUILD_+"win32",["build-native-project"]),n.task(BUILD_+"mac",["build-native-project"]);var P=BUILD_+c;if(P in n.tasks){var k;k=g?[h.res+"/**/*",h.src+"/*/"]:Path.join(d,"**/*"),Editor.log("Delete "+k),Del(k,{force:!0},e=>{if(e)return t(e);n.start(P,function(e){e?t(e):(g||Editor.Ipc.sendToMain("app:update-build-preview-path",d),t())})})}else{var q=[];for(var O in n.tasks)0===O.indexOf(BUILD_)&&q.push(O.substring(BUILD_.length));t(new Error(Format("Not support %s platform, available platform currently: %s",c,q)))}},exports.getTemplateFillPipe=getTemplateFillPipe,exports.buildSettings=buildSettings;