const Async=require("async"),Path=require("fire-path"),DEBUG_WORKER=!1,CONCURRENCY=1;var Compiler={_queue:Async.queue(function(e,t){Compiler._runTask(e,function(r){for(var o=e.context.callbacks,i=0;i<o.length;i++){var s=o[i],c=i<o.length-1;c||Editor.log("Compiled project javascript file successfully"),s(r,c)}t(r)})},1),isScript:function(e){return"javascript"===e||"coffeescript"===e||"typescript"===e},needCompile:function(e,t){if("javascript"===e){var r=Editor.assetdb._uuid2meta[t]||Editor.assetdb.loadMetaByUuid(t);return!r||!r.isPlugin}return"coffeescript"===e||"typescript"===e},compileScripts:function(e,t){if(this.errorScriptUuids.length>0)return t&&t(!1,!1),void 0;var r=Date.now();this.state="compiling",Editor.Ipc.sendToWins("compiler:state-changed",this.state),this.doCompile({project:Editor.projectPath,debug:!0,useCache:!0,recreateCache:e},(e,o)=>{o||(e?(Editor.error(e),this.errors.push(e.toString())):(this.errors.forEach(e=>{Editor.clearLog(e)}),this.errors.length=0),this.state=e?"failed":"idle",Editor.Ipc.sendToWins("compiler:state-changed",this.state),console.log("Compile Time: "+((Date.now()-r)/1e3).toFixed(3)+"ms")),t&&t(!e,o)})},doCompile:function(e,t){if(e.useCache){var r=Path.join(Editor.projectPath,"temp",Editor.versions.CocosCreator,"scripts-compile-cache");e.cacheDir=r}var o=JSON.stringify(e);Object.defineProperty(e,"context",{value:{}});var i=this._queue.workersList();if(i.length>0){0;var s=i[0].data,c=s.context;if(!c.isAborted){var a=JSON.stringify(s)===o;if(a)return e.context.callbacks=c.callbacks.concat(t),c.callbacks.length=0,this._queue.unshift(e),c.isAborted=!0,c.worker&&c.worker.isLoaded&&c.worker.forceClose(),void 0}}for(var n=this._queue.tasks,l=0;l<n.length;l++){var u=n[l];if(a=JSON.stringify(u.data)===o,a)return u.data.context.callbacks.push(t),void 0}e.context.callbacks=[t],this._queue.push(e)},_runTask:function(e,t){var r=null,o=!1;Editor.App.spawnWorker("app://editor/page/compile-worker",function(i,s){if(o||(o=!0,s.once("closed",function(){i=null,e.context.worker=null,t&&t(r)})),e.context.isAborted)return i.forceClose(),void 0;e.context.worker=i,i.send("app:compile-worker-start",e,(t,o)=>{e.context.isAborted||(o&&(r=r||o),i&&i.nativeWin.isDestroyed()||i&&!Compiler.debugWorker&&i.close())},-1)},Compiler.debugWorker,!0)},debugWorker:!1};module.exports=Compiler;