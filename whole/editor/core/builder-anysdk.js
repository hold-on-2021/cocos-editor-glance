const Path=require("fire-path"),Fs=require("fire-fs"),Globby=require("globby"),Del=require("del"),xcode_strs=["AB2EB9CB1D34F41700695C92 /* anysdk/jsb_anysdk_basic_conversions.cpp in Sources */ = {isa = PBXBuildFile; fileRef = AB2EB9C31D34F41700695C92 /* jsb_anysdk_basic_conversions.cpp */; };","AB2EB9CC1D34F41700695C92 /* anysdk/jsb_anysdk_protocols_auto.cpp in Sources */ = {isa = PBXBuildFile; fileRef = AB2EB9C51D34F41700695C92 /* jsb_anysdk_protocols_auto.cpp */; };","AB2EB9CD1D34F41700695C92 /* anysdk/manualanysdkbindings.cpp in Sources */ = {isa = PBXBuildFile; fileRef = AB2EB9C71D34F41700695C92 /* manualanysdkbindings.cpp */; };","AB2EB9CE1D34F41700695C92 /* anysdk/SDKManager.cpp in Sources */ = {isa = PBXBuildFile; fileRef = AB2EB9C91D34F41700695C92 /* SDKManager.cpp */; };","ABE457031D35198000F1F400 /* libPluginProtocol.a in Frameworks */ = {isa = PBXBuildFile; fileRef = ABE457021D35198000F1F400 /* libPluginProtocol.a */; };","AB2EB9CB1D34F41700695C92 /* anysdk/jsb_anysdk_basic_conversions.cpp in Sources */,","AB2EB9CC1D34F41700695C92 /* anysdk/jsb_anysdk_protocols_auto.cpp in Sources */,","AB2EB9CD1D34F41700695C92 /* anysdk/manualanysdkbindings.cpp in Sources */,","AB2EB9CE1D34F41700695C92 /* anysdk/SDKManager.cpp in Sources */,","ABE457031D35198000F1F400 /* libPluginProtocol.a in Frameworks */,",'AB2EB9C31D34F41700695C92 /* anysdk/jsb_anysdk_basic_conversions.cpp */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; path = anysdk/jsb_anysdk_basic_conversions.cpp; sourceTree = "<group>"; };','AB2EB9C51D34F41700695C92 /* anysdk/jsb_anysdk_protocols_auto.cpp */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; path = anysdk/jsb_anysdk_protocols_auto.cpp; sourceTree = "<group>"; };','AB2EB9C71D34F41700695C92 /* anysdk/manualanysdkbindings.cpp */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; path = anysdk/manualanysdkbindings.cpp; sourceTree = "<group>"; };','AB2EB9C91D34F41700695C92 /* anysdk/SDKManager.cpp */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; path = anysdk/SDKManager.cpp; sourceTree = "<group>"; };','ABE457021D35198000F1F400 /* libPluginProtocol.a */ = {isa = PBXFileReference; lastKnownFileType = archive.ar; name = libPluginProtocol.a; path = ios/anysdk/libPluginProtocol.a; sourceTree = "<group>"; };',"AB2EB9C31D34F41700695C92 /* anysdk/jsb_anysdk_basic_conversions.cpp */,","AB2EB9C51D34F41700695C92 /* anysdk/jsb_anysdk_protocols_auto.cpp */,","AB2EB9C71D34F41700695C92 /* anysdk/manualanysdkbindings.cpp */,","AB2EB9C91D34F41700695C92 /* anysdk/SDKManager.cpp */,","ABE457021D35198000F1F400 /* libPluginProtocol.a */,"],xcode_regexs=[/.* anysdk\/jsb_anysdk_basic_conversions\.cpp.*isa = PBXBuildFile.*/,/.* anysdk\/manualanysdkbindings\.cpp.*isa = PBXBuildFile.*/,/.* anysdk\/SDKManager\.cpp.*isa = PBXBuildFile.*/,/.* anysdk\/jsb_anysdk_protocols_auto\.cpp.*isa = PBXBuildFile.*/,/.* libPluginProtocol\.a.*isa = PBXBuildFile.*/,/ *\S* \/\* anysdk\/manualanysdkbindings.cpp in Sources \*\/,/,/ *\S* \/\* anysdk\/jsb_anysdk_basic_conversions.cpp in Sources \*\/,/,/ *\S* \/\* anysdk\/SDKManager.cpp in Sources \*\/,/,/ *\S* \/\* anysdk\/jsb_anysdk_protocols_auto.cpp in Sources \*\/,/,/ *\S* \/\* libPluginProtocol.a in Frameworks \*\/,/,/.* anysdk\/jsb_anysdk_basic_conversions\.cpp.*isa = PBXFileReference.*/,/.* anysdk\/manualanysdkbindings\.cpp.*isa = PBXFileReference.*/,/.* anysdk\/SDKManager\.cpp.*isa = PBXFileReference.*/,/.* anysdk\/jsb_anysdk_protocols_auto\.cpp.*isa = PBXFileReference.*/,/.* libPluginProtocol\.a.*isa = PBXFileReference.*/,/ *\S* \/\* anysdk\/manualanysdkbindings.cpp \*\/,/,/ *\S* \/\* anysdk\/jsb_anysdk_basic_conversions.cpp \*\/,/,/ *\S* \/\* anysdk\/SDKManager.cpp \*\/,/,/ *\S* \/\* anysdk\/jsb_anysdk_protocols_auto.cpp \*\/,/,/ *\S* \/\* libPluginProtocol.a \*\/,/],add_to_map={"/* End PBXBuildFile section */":{range:[0,4]},"/* RootViewController.mm in Sources */,":{range:[5,8]},"/* MobileCoreServices.framework in Frameworks */,":{range:[9,9]},"/* End PBXFileReference section */":{range:[10,14]},"/* AppDelegate.cpp */,":{range:[15,18]},"/* RootViewController.mm */,":{range:[19,19]}},AnySDKString='\n<script charset="utf-8" id="protocols" type="text/javascript">\n  var protocols = document.createElement("script");\n  protocols.onload = function () {\n    anysdk.agentManager.init();\n    anysdk.agentManager.loadAllPlugins(function (code, msg) {\n    });\n  };\n  protocols.src = "http://statics.h5.anysdk.com/protocols/protocols.js";\n  document.body.appendChild(protocols);\n<\/script>\n';module.exports={init(e){e.on("build-finished",this.onBuildFinished.bind(this))},onBuildFinished(e,s){if("web-mobile"===e.platform)return this.indexHtml(e),s();if("android"!==e.platform&&"ios"!==e.platform)return s();e=Object.assign({},e);let n;n=Editor.isMainProcess?require("./native-utils").getCocosRoot():Editor.remote.builtinCocosRoot,e.cocosRoot=n,this.ensureFiles(e),this.mainJs(e),this.sdkManager(e),this.xcode(e),this.android(e),s()},ensureFiles(e){let s=Path.join(e.cocosRoot,"extensions/anysdk/"),n=Path.join(e.dest,"frameworks/runtime-src/Classes/anysdk"),i=[{srcDir:Path.join(s,"Classes"),destDir:n}];if(("ios"!==e.platform||e.jailbreakPlatform)&&(i.push({srcDir:Path.join(s,"src"),destDir:Path.join(e.dest,"src/anysdk")}),i.push({srcDir:Path.join(s,"js-bindings"),destDir:n})),"android"===e.platform){let n=e.androidStudio,a=Path.join(s,"platform/android"),o=Path.join(e.dest,"frameworks/runtime-src/",n?"proj.android-studio/app":"proj.android"),r={srcDir:a,destDir:o,exludes:[]};n?(r.exludes.push("!"+Path.join(a,"libs/libPluginProtocol.jar")),r.exludes.push("!"+Path.join(a,"res/drawable/**")),r.exludes.push("!"+Path.join(a,"res/layout/**")),r.exludes.push("!"+Path.join(a,"res/mipmap-layout/**")),i.push({srcDir:Path.join(a,"res/mipmap-layout"),destDir:Path.join(o,"res/layout")})):(r.exludes.push("!"+Path.join(a,"/res/mipmap/**")),r.exludes.push("!"+Path.join(a,"/res/mipmap-layout/**")),r.exludes.push("!"+Path.join(a,"/libs/mipmap**"))),r.exludes.push("!"+Path.join(a,"src/**")),i.push(r)}else if("ios"===e.platform){let a=Path.join(e.dest,"frameworks/runtime-src/proj.ios_mac/ios/anysdk"),o=Path.join(e.cocosRoot,"external/ios");e.jailbreakPlatform?i.push({srcDir:Path.join(o,"libs/anysdk/common"),destDir:a}):(i.push({srcDir:Path.join(s,"/platform/ios/appstore/js-bindings"),destDir:n}),i.push({srcDir:Path.join(s,"/platform/ios/appstore/src"),destDir:Path.join(e.dest,"src/anysdk")}),i.push({srcDir:Path.join(o,"libs/anysdk/appstore"),destDir:a}))}i.forEach(s=>{let n=[Path.join(s.srcDir,"**")];s.exludes&&(n=n.concat(s.exludes));Globby.sync(n).forEach(n=>{let i=Path.relative(s.srcDir,n),a=Path.join(s.destDir,i);Fs.isDirSync(n)||(e.includeAnySDK?Fs.copySync(n,a):Del.sync(a,{force:!0}))})})},indexHtml(e){if(!e.includeAnySDK)return;let s=Path.join(e.dest,"index.html"),n=Fs.readFileSync(s,"utf8").split("\n");for(let e=0;e<n.length;e++){if(n[e].match(/src="main.js"/)){n.splice(e+1,0,AnySDKString);break}}Fs.writeFileSync(s,n.join("\n"))},mainJs(e){let s=Path.join(e.dest,"main.js"),n=Fs.readFileSync(s,"utf8").split("\n");for(let s=0;s<n.length;s++){let i=n[s];i.match(/.*jsb_anysdk.js.*jsb_anysdk_constants.js/)&&(e.includeAnySDK?n[s]=i.replace(/\/\//g,""):-1===i.indexOf("//")&&(n[s]="//"+i))}Fs.writeFileSync(s,n.join("\n"))},xcode(e){if("ios"!==e.platform)return;let s=Path.join(e.dest,`frameworks/runtime-src/proj.ios_mac/${e.projectName}.xcodeproj/project.pbxproj`),n=Fs.readFileSync(s,"utf8").split("\n"),i=[],a=e.jailbreakPlatform?"common":"appstore";for(let s=0;s<n.length;s++){let r=n[s];if(e.includeAnySDK||!r.match(/\s*PACKAGE_AS,\s*/))if(e.includeAnySDK&&r.match(/\s*PACKAGE_AS_PLACEHOLDER,\s*/))n[s]="PACKAGE_AS,";else{n[s]=r=r.replace(/\/external\/ios\/include\/anysdk\/([a-zA-Z]*)/,`/external/ios/include/anysdk/${a}`);for(let a=0;a<xcode_regexs.length;a++)if(r.match(xcode_regexs[a])){if(!e.includeAnySDK){n.splice(s,1),s--;break}i.push(a)}if(e.includeAnySDK)for(let e in add_to_map)if(-1!==r.indexOf(e)){let a=add_to_map[e].range[0],r=add_to_map[e].range[1];for(let t=a;t<=r;t++)if(-1===i.indexOf(t)){var o=xcode_strs[t];add_to_map[e].after?n.splice(s+1,0,o):n.splice(s,0,o),s++}}}else n[s]="PACKAGE_AS_PLACEHOLDER,"}Fs.writeFileSync(s,n.join("\n"))},android(e){"android"===e.platform&&[Path.join(e.dest,"frameworks/runtime-src/proj.android"),Path.join(e.dest,"frameworks/runtime-src/proj.android-studio/app")].forEach(s=>{let n=Path.join(s,"jni/Application.mk"),i=Fs.readFileSync(n,"utf8").split("\n"),a=!1;for(let s=0;s<i.length;s++){let n=i[s];n.match(/\bUSE_ANY_SDK\b.*:=.*1/)&&(e.includeAnySDK?-1!==n.indexOf("#")&&(i[s]=n.replace(/#/g,""),a=!0):n.match(/.*#.*\bUSE_ANY_SDK\b.*:=.*1/)||(i[s]="#"+n,a=!0))}a&&Fs.writeFileSync(n,i.join("\n"))})},sdkManager(e){let s=Path.join(e.dest,"frameworks/runtime-src/Classes/anysdk/SDKManager.cpp");if(!Fs.existsSync(s))return;let n=Fs.readFileSync(s,"utf8");n=(n=(n=(n=n.replace(/std::string oauthLoginServer = ".*";/,`std::string oauthLoginServer = "${e.oauthLoginServer}";`)).replace(/std::string appKey = ".*";/,`std::string appKey = "${e.appKey}";`)).replace(/std::string appSecret = ".*";/,`std::string appSecret = "${e.appSecret}";`)).replace(/std::string privateKey = ".*";/,`std::string privateKey = "${e.privateKey}";`),Fs.writeFileSync(s,n)}};