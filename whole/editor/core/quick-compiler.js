function transform(e,t){function i(e,i){if(".json"===Path.extname(s)&&".js"===Path.extname(r)&&(i="module.exports = "+i),-1===i.indexOf("cc._RF.push")?h+=`cc._RF.push(module, '', '${c}', __filename);`:i=i.replace(/\bcc._RF.push\b\ *\(([^)]*)\)/g,function(e,t){return`cc._RF.push(${t}, __filename)`}),-1===i.indexOf("cc._RF.pop")&&(d="\ncc._RF.pop();"+d),i=h+i+d,Fs.ensureDirSync(Path.dirname(r)),Fs.writeFileSync(r,i),!l)return t();let o=Path.extname(a),n=JSON.parse(Fs.readFileSync(p,"utf8"));n.sources=[`${c}${o}`],n=JSON.stringify(n);let u=r+".map";Fs.writeFileSync(u,n),t()}let s=e.src,r=e.dest,o=e.relative,a=e.rawPath,n=e.through;if(".json"===Path.extname(s)&&".json"===Path.extname(r))return Fs.copySync(s,r),t();let p=s+".map",l=Fs.existsSync(p),c=Path.basenameNoExt(r),h='(function() {"use strict";var __module = CC_EDITOR ? module : {exports:{}};'+`var __filename = '${Path.join(PREVIEW_PATH,o).replace(/\\/g,"/")}';`+"var __require = CC_EDITOR ? function (request) {return cc.require(request, require);} : function (request) {return cc.require(request, __filename);};function __define (exports, require, module) {",d=`\n        }\n        if (CC_EDITOR) {\n            __define(__module.exports, __require, __module);\n        }\n        else {\n            cc.registerModuleFunc(__filename, function () {\n                __define(__module.exports, __require, __module);\n            });\n        }\n        })();\n        ${l?`//# sourceMappingURL=${c}.js.map`:""}\n        `;n?n(s,i):Fs.readFile(s,"utf8",i)}const Fs=require("fire-fs"),Path=require("fire-path"),Mdeps=require("module-deps"),JSONStream=require("JSONStream"),Concat=require("concat-stream"),BrowserResolve=require("browser-resolve"),Globby=require("globby"),Async=require("async"),Del=require("del"),xtend=require("xtend"),builtins=require("browserify/lib/builtins.js"),insertGlobals=require("insert-module-globals"),Lodash=require("lodash"),TEMP_PATH="temp/quick-scripts",TEMP_NODE_MODULE_PATH="__node_modules",PREVIEW_PATH="preview-scripts",COMBINE_COMPILE_SCRIPTS_TIMEOUT=100;var Compiler={state:"idle",scripts:[],scriptsCache:[],nameToPathMap:{},errorScripts:{},_depsStack:[],_pathsToUpdate:[],_scriptsToCompile:[],getAssetDb:()=>Editor.isMainProcess?Editor.assetdb:Editor.remote.assetdb,getTempPath:()=>Path.join(Editor.projectInfo.path,TEMP_PATH),getRelativePath(e){let t=this.getAssetDb().mountInfoByPath(e);return Path.join(t.mountPath,Path.relative(t.path,e))},getRawPathToTempPath(e){let t=this.getRelativePath(e);return Path.join(this.getTempPath(),Path.stripExt(t)+".js")},isScript:function(e){return"javascript"===e||"coffeescript"===e||"typescript"===e},isPlugin:function(e){var t=this.getAssetDb()._uuid2meta[e]||this.getAssetDb().loadMetaByUuid(e);return t&&t.isPlugin},needCompile:function(e,t){return"javascript"===e?!this.isPlugin(t):"coffeescript"===e||"typescript"===e},updateState(e){this.state=e,Editor.Ipc.sendToWins("compiler:state-changed",e)},init(e){let t=this.getTempPath();try{Del.sync(t,{force:!0})}catch(e){Editor.error(e)}console.time("init QuickCompiler"),this.updateState("compiling");let i=[Path.join(Editor.projectInfo.path,"library/imports","/**/*.js")];Globby(i,(t,i)=>{this.nameToPathMap={},Async.each(i,(e,t)=>{this.copyImportToTemp(e,t)},t=>{this.updateScriptsCache(()=>{e&&e(),console.timeEnd("init QuickCompiler"),this.updateState("idle")})})})},compileAndReload(){this.init(()=>{this.reloadScripts()})},copyImportToTemp(e,t){let i=this.getTempPath(),s=Path.basenameNoExt(e);if(this.isPlugin(s))return t();let r=this.getAssetDb().uuidToFspath(s),o=this.getRelativePath(r),a=Path.join(i,o);o=Path.stripExt(o)+".js",a=Path.stripExt(a)+".js",this._pathsToUpdate.push(a),this.nameToPathMap[Path.basenameNoExt(a).toLowerCase()]=a,transform({src:e,dest:a,relative:o,rawPath:r},t)},getNodeModulePathInfo(e){let t=this.getTempPath(),i=Path.join("__node_modules",e.substring(e.indexOf("/node_modules/")+"/node_modules/".length,e.length));return{relative:i=Path.stripExt(i)+".js",dest:Path.join(t,i)}},updateNodeModules(e,t){for(let t in e.deps){let i=e.deps[t];if(this.isNodeModulePath(i)){let s=this.getNodeModulePathInfo(i);e.deps[t]=s.dest}}this.isNodeModulePath(e.file)?(e.isNodeModule=!0,this.copyNodeModuleToTemp(e,t)):t&&t()},copyNodeModuleToTemp(e,t){this.getTempPath();let i=e.file,s=this.getNodeModulePathInfo(i);e.file=s.dest;transform({src:i,dest:s.dest,relative:s.relative,rawPath:i,through:function(t,i){i(null,e.source)}},t)},singleScriptCompileFailed:function(e){let t=this.errorScripts[e.uuid];t||(t=this.errorScripts[e.uuid]=[]),t.push(e.error.toString()),this.updateState("failed")},compileScripts(e,t){e.forEach(e=>{-1===this._scriptsToCompile.indexOf(e)&&this._scriptsToCompile.push(e)}),this._compileScripts(t)},_compileScripts(e){var t=this._scriptsToCompile;this.updateState("compiling"),Async.each(t,(e,t)=>{if(this.isPlugin(e))return t();let i=this.getAssetDb()._uuidToImportPathNoExt(e)+".js";if(!Fs.existsSync(i))return Editor.error(`Can not find import path [${i}]`),t();this.copyImportToTemp(i,s=>{if(s)return Editor.error(`Copy ${i} to temp path failed`),t();let r=this.errorScripts[e];r&&(r.forEach(e=>{Editor.clearLog(e)}),delete this.errorScripts[e]),t()})},i=>{i&&Editor.error(i),t.length=0,console.time("compileScript"),this.updateScriptsCache(()=>{this.reloadScripts(),this.updateState("idle"),console.timeEnd("compileScript"),e&&e()})})},scriptUuidChanged(e,t){this.errorScripts[e]&&(this.errorScripts[t]=this.errorScripts[e],delete this.errorScripts[e])},reloadScripts(){Editor.Ipc.sendToWins("scene:soft-reload",!0)},moveScripts(e,t){this.removeScripts(e,t),this.compileScripts(t)},removeScripts(e,t){let i=e.map(e=>{let t=this.getRawPathToTempPath(e);t=t.replace(/\\/g,"/"),Fs.existsSync(t)&&Del.sync(t,{force:!0});let i=t+".map";Fs.existsSync(i)&&Del.sync(i,{force:!0});let s=Path.basenameNoExt(t);return delete this.nameToPathMap[s.toLowerCase()],t});this._scriptsToCompile=this._scriptsToCompile.filter(e=>-1===t.indexOf(e)),this.scriptsCache=this.scriptsCache.filter(e=>-1===i.indexOf(e.file)),this.resortScripts()},makePathToMacPath(e){e.file=e.file.replace(/\\/g,"/");for(let t in e.deps)e.deps[t]=e.deps[t].replace(/\\/g,"/")},isNodeModulePath:e=>-1!==e.replace(/\\/g,"/").indexOf("/node_modules/"),updateScriptsCache(e){let t=this._pathsToUpdate,i=Concat(t=>{let i=t.toString();i=`{"scripts": ${i}}`;let s=[];try{s=JSON.parse(i).scripts}catch(e){Editor.error(e)}let r=this.scriptsCache;Async.each(s,(e,t)=>{this.makePathToMacPath(e),this.updateNodeModules(e,()=>{let i=r.findIndex(t=>t.file===e.file);-1===i?r.push(e):r.splice(i,1,e),t()})},t=>{this.resortScripts(),e&&e(t)})});var s={extensions:[".js",".json"],ignoreMissing:!0};s.resolve=((e,t,i)=>{let s=Path.basename(e);s.endsWith(".js")?s=s.slice(0,-3):s.endsWith(".json")&&(s=s.slice(0,-5));let r=this.nameToPathMap[s.toLowerCase()];if(!this.isNodeModulePath(t.filename)&&r)return i(null,r);t.paths=require.main.paths.concat(t.paths),BrowserResolve(e,t,i)}),s.modules=xtend(builtins);var r={process:function(){return"require('_process')"}};s.globalTransform=function(e){return insertGlobals(e,{vars:r})},s.fileCache={},Async.eachSeries(t,(e,t)=>{Fs.readFile(e,"utf8",(i,r)=>{i?Editor.error(i):s.fileCache[e]=r,t()})},()=>{var e=new Mdeps(s);e.pipe(JSONStream.stringify()).pipe(i);for(let i=0;i<t.length;i++)e.write({file:t[i]});t.length=0,e.end()})},resortScripts(){let e=this.getTempPath(),t=this.scriptsCache=Lodash.sortBy(this.scriptsCache,"file");this.scripts=t.map(i=>{let s={};for(let e in i.deps)s[e]=t.findIndex(function(t){return t.file===i.deps[e]});return{isNodeModule:i.isNodeModule,deps:s,file:Path.join(PREVIEW_PATH,Path.relative(e,i.file)).replace(/\\/g,"/")}})}};if(Compiler._compileScripts=Lodash.debounce(Compiler._compileScripts,100),Editor.isMainProcess){require("electron").ipcMain.on("app:query-status",function(){Editor.Ipc.sendToWins("compiler:state-changed",Compiler.state)})}module.exports=Compiler;