const Path=require("fire-path"),Fs=require("fire-fs"),Async=require("async"),Del=require("del"),packer=require("./packer");exports.queryAtlases=function(e,r){let t={spriteFrames:[],textures:[],pacInfos:[]},a=Editor.url("db://assets");e=e instanceof Array?e:[e],Async.eachSeries(e,(e,r)=>{let i=e.path,s=i+".meta",n=Fs.readJSONSync(s),o=Path.dirname(e.url)+"/**/*";Editor.assetdb.queryAssets(o,["sprite-frame"],(s,o)=>{if(s)return r(s);if(0===o.length)return Editor.warn(`No SpriteFrame find in forlder [${Path.dirname(e.url)}]. Please check the AutoAtlas [${i}].`),r();let c=[];Async.eachSeries(o,(e,r)=>{cc.AssetLibrary.loadAsset(e.uuid,(e,t)=>{if(e)return r(e);c.push(t),r()})},s=>{if(s)return r(s);let o={meta:n,info:e,spriteFrames:c,relativePath:Path.relative(a,i),relativeDir:Path.relative(a,Path.dirname(i))};c.forEach(e=>{e.pacInfo=o}),t.spriteFrames=t.spriteFrames.concat(c),t.pacInfos.push(o),r()})})},e=>{r&&r(e,t)})},exports.pack=function(e,r){let t=e.dest,a=e.pacInfos,i=e.clear,s=e.needPackSpriteFrames,n=[];Async.eachSeries(a,(e,a)=>{let o=e.meta,c=e.relativeDir,u=Path.join(t,c);i&&Del.sync(u,{force:!0}),Fs.ensureDirSync(u);let l=cc.js.mixin({name:Path.basenameNoExt(e.info.path),path:u,width:o.maxWidth,height:o.maxHeight},o),h=e.spriteFrames;if(o.filterUnused&&s){let r=Editor.url("db://assets/resources");-1!==e.info.path.indexOf(r)?Editor.warn(`AutoAtlas [${e.info.path}] is in resources dir. Option [Filter Unused] will not be used.`):h=h.filter(e=>{for(let r=0;r<s.length;r++)if(s[r]._uuid===e._uuid)return!0;return!1})}if(0===h.length)return r(new Error(`No SpriteFrame provides. Please check your options. Abort pack AutoAtlas [${e.info.path}].`));packer(h,l,(r,t)=>{if(r)return a(r);t.pacInfo=e,n.push(t),a()})},e=>{r&&r(e,n)})};