"use strict";function _loadEngine(){var e=[null,null];let t=Editor.App._profile.data;try{require(Editor.url("unpack://engine"))}catch(i){if(t["use-default-js-engine"])e[1]=i;else{e[0]=i;try{Editor.App._profile.data["use-default-js-engine"]=!0,Editor.App._profile.save(),require(Editor.url("unpack://engine"))}catch(t){e[1]=t}}}return e}const Electron=require("electron"),ipcMain=Electron.ipcMain,Fs=require("fire-fs"),Path=require("fire-path"),Async=require("async");module.exports=function(e,t){Editor.Profile.register("global",Editor.App.home),Editor.log("Load ~/.CocosCreator/settings.json"),Editor.App._profile=Editor.Profile.load("profile://global/settings.json",{"recently-opened":[],"last-create":"","last-login":"",language:"unknown","remember-passwd":!0,"node-tree-state":1,"local-ip":1,"show-console-log":!1,"show-meta-backup-dialog":!0,"trim-imported-image":!0,step:.1,"auto-sync-prefab":!1,"auto-compiler-scripts":!0,"script-editor":"default","picture-editor-root":"","script-editor-list":[],"ndk-root":process.env.NDK_ROOT||"","android-sdk-root":process.env.ANDROID_SDK_ROOT||"","ant-root":process.env.ANT_ROOT||"","js-engine-path":"","use-default-js-engine":!0,"cpp-engine-path":"","use-default-cpp-engine":!0,"preview-platform":"browser","preview-browser":"default","preview-browser-list":[],"simulator-resolution":1,"simulator-orientation":!1,"auto-refresh":!0,"wechatgame-app-path":""}),Editor.log("checking language setting...");let i=Editor.App._profile.data;if("en"===i.language||"zh"===i.language)Editor.lang=Editor.Package.lang=i.language;else{let e="zh";if("linux"!==process.platform){e=0===Editor.Dialog.messageBox({type:"question",buttons:["中文","English"],title:"Choose Language",message:"Please choose your language / 请选择语言",detail:"",defaultId:0,cancelId:0,noLink:!0})?"zh":"en"}Editor.lang=Editor.Package.lang=i.language=e,Editor.App._profile.save()}Editor.log("Language: "+Editor.lang),Editor.init({profile:{global:Editor.App.home},i18n:require(`../share/i18n/${Editor.lang}/localization`),"main-menu":require("./core/main-menu"),"panel-window":"unpack://static/window.html",layout:"unpack://static/layout/landscape.json",selection:["asset","node"],"package-search-path":[Editor.dev?"app://builtin":"app://../builtin","app://editor/builtin"],theme:"default","theme-search-path":["app://themes"]}),Editor.Profile.setDefault("profile://global/updates.json",{"received-ids":[],"installed-hotupdates":[]}),require("./core/editor-init"),require("./core/ipc"),require("./core/create-package.js"),Editor.updateIpAddress();let o=Path.join(Editor.projectPath,"local","layout.windows.json");if(Fs.existsSync(o)){let e;try{e=JSON.parse(Fs.readFileSync(o,"utf8"))}catch(t){e=null}finally{e&&e.version||(Editor.warn("Invalid layout profile, remove old profile and init a new one at: "+o),Fs.removeSync(o))}}Async.series([e=>{require("../share/check-internet").checkInternet(function(t){Editor.isOffline=!t,Editor.isOffline&&(Editor.requireLogin=!1),e()})},t=>{if(Editor.argv._command)return t(),void 0;if(Fs.existsSync(Editor.projectPath))return t(),void 0;e.template,Editor.log("Create project %s",Editor.projectPath),Editor.Project.create(Editor.projectPath,void 0,t)},e=>{if(Editor.argv._command)return e(),void 0;Editor.log("Check project %s",Editor.projectPath),Editor.Project.check(Editor.projectPath,function(t,i){if(t)return e(t),void 0;Editor.projectInfo=i,e()})},e=>{Editor.log("Initializing Cocos2d");let t=Editor.App._profile.data["use-default-js-engine"],i=_loadEngine(),o="",r=null;if(t&&i[1]?(o=Editor.T("EDITOR_MAIN.builtin_engine_failed"),r=i[1]):!t&&i[0]&&(i[1]?(r=i[1],o=Editor.T("EDITOR_MAIN.builtin_engine_failed")):(r=i[0],o=Editor.T("EDITOR_MAIN.custom_engine_failed"))),r&&Editor.Dialog.messageBox({type:"error",buttons:[Editor.T("MESSAGE.ok")],message:o,detail:r.stack,noLink:!0}),i[1])return e(r),void 0;e()},e=>{console.log("Initializing engine extends");try{require("./share/engine-extends/init"),require("./share/engine-extends/serialize")}catch(t){return Editor.Dialog.messageBox({type:"error",buttons:["OK"],title:"Initializing engine extends failed",message:"Maybe the reason is: You are using custom JS engine and it is out-dated.",detail:`Error call stack : ${t.stack}`,defaultId:0,cancelId:0,noLink:!0}),e(t),void 0}e()},e=>{Editor.log("Initializing Asset Database"),require("./core/asset-db"),Editor.libraryPath=Editor.assetdb.library,Editor.importPath=Editor.assetdb._importPath,e()},e=>{if(Editor.argv._command)return e(),void 0;Editor.log("Loading editor/builtin packages"),Editor.loadPackagesAt(Path.join(Editor.App.path,"editor","builtin"),e)},e=>{if(Editor.argv._command)return e(),void 0;Editor.log("Loading builtin packages"),Editor.loadPackagesAt(Path.join(Editor.App.path,Editor.dev?"":"..","builtin"),e)},e=>{if(Editor.argv._command)return e(),void 0;try{require("./share/register-builtin-assets"),require("./core/init-builtin-assets")}catch(t){return Editor.Dialog.messageBox({type:"error",buttons:["OK"],title:"Register builtin assets failed",message:"Maybe the reason is: You are using custom JS engine and it is out-dated.",detail:`Error call stack : ${t.stack}`,defaultId:0,cancelId:0,noLink:!0}),e(t),void 0}e()},e=>{Editor.log("Initializing project %s",Editor.projectPath),Fs.ensureDirSync(Path.join(Editor.projectPath,"settings")),Editor.Profile.register("project",Path.join(Editor.projectPath,"settings")),Fs.ensureDirSync(Path.join(Editor.projectPath,"local")),Editor.Profile.register("local",Path.join(Editor.projectPath,"local")),Editor.Package.addPath([Path.join(Editor.App.home,"packages"),Path.join(Editor.projectPath,"packages")]),Editor._projectLocalProfile=Editor.Profile.load("profile://local/local.json",{"last-edit":""}),Editor._projectProfile=Editor.Profile.load("profile://project/project.json",{"start-scene":"current","group-list":["default"],"collision-matrix":[[!0]],"excluded-modules":[],"design-resolution-width":960,"design-resolution-height":640,"fit-width":!1,"fit-height":!0,"use-project-simulator-setting":!1,"simulator-orientation":!1,"use-customize-simulator":!1,"simulator-resolution":{width:960,height:640},"cocos-analytics":{enable:!1,appID:"13798",appSecret:"959b3ac0037d0f3c2fdce94f8421a9b2"}}),e()}],e=>{t&&t(e)})},Editor.App.extend({runDashboard(){Editor._runDashboard=!0,Editor.Window.main.close()},run(){let e=require("../share/engine-utils");Editor.builtinCocosRoot=e.getEnginePath(),Editor.sceneList=[],Editor.currentSceneUuid="",Async.series([e=>{Editor.assetdb.mount(Editor.url("unpack://static/default-assets/"),"internal",{hidden:!Editor.showInternalMount},e)},e=>{if(!Editor.externalMounts||0===Editor.externalMounts.length)return e(),void 0;Async.each(Editor.externalMounts,(e,t)=>{Editor.assetdb.mount(e.path,e.name,{readonly:!Editor.mountsWritable},t)},e)},e=>{Editor.assetdb.mount(Path.join(Editor.projectPath,"assets"),"assets",e)},e=>{let t=new Editor.Window("importing",{title:"Importing",width:350,height:120,alwaysOnTop:!0,show:!1,resizable:!1,save:!1,frame:!1});t.load("app://editor/page/import-waiting.html"),t.nativeWin.once("ready-to-show",()=>{t.show()}),Editor.assetdb.init(function(i,o){Editor.assetdbInited=!0,t.close(),e()})},e=>{Editor.assetdb.queryAssets(null,"scene",function(e,t){Editor.sceneList=t.map(e=>e.uuid)});let t=Editor._projectLocalProfile.data["last-edit"];Editor.assetdb.existsByUuid(t)||(t=Editor._projectProfile.data["start-scene"],Editor.assetdb.existsByUuid(t)||(t=null),Editor._projectLocalProfile.data["last-edit"]=t,Editor._projectLocalProfile.save()),Editor.currentSceneUuid=t,e()},e=>{Editor.MainMenu.add(Editor.T("MAIN_MENU.node.title"),Editor.Menu.getMenu("create-node")),e()},e=>{if(Editor._commandLinePublish)return e();Editor.PreviewServer.start(function(e){Editor.stashedScene?e():(ipcMain.once("app:preview-server-scene-stashed",e),Editor.Ipc.sendToWins("scene:preview-server-scene-stashed"))},e)},e=>{Editor.QuickCompiler.init(e)},e=>"string"==typeof Editor._buildCommand?(Editor.Builder.buildCommand(Editor._buildCommand,t=>{t&&Editor.error(t),e(),Electron.app.quit()}),void 0):"string"==typeof Editor._compileCommand?(Editor.Builder.compileCommand(Editor._compileCommand,t=>{t&&Editor.error(t),e(),Electron.app.quit()}),void 0):(e(),void 0),e=>{if(Editor._commandLinePublish)return e();Editor.run("app://editor/index.html",{title:"Cocos Creator",width:1280,height:720,minWidth:100,minHeight:100,show:!1,resizable:!0});var t=Editor.Window.main;t.nativeWin.on("close",function(){t.closing=!0}),ipcMain.on("app:is-main-window-attemp-to-close",e=>{e.returnValue=!!t.closing,t.closing=!1}),Editor.Metrics.setClientId(function(){Editor.Metrics.prepareUserIdentity(),Editor.Metrics.sendAppInfo(),Editor.Metrics.trackEvent({category:"Editor",action:"Editor Open",label:"new metrics"})}),e()}],e=>{e&&Editor.error("Failed to run editor, message: %s",e.stack)})},quit(e){Editor.Metrics.trackEvent({category:"Editor",action:"Editor Close",label:"new metrics"},e),setTimeout(function(){console.log("quit due to request timeout"),e()},2e3)},spawnWorker(e,t,i,o,r){function a(){s&&(clearTimeout(s),s=null);const e=new Editor.Window("worker",{show:!!o,save:!1});s=setTimeout(()=>{s=null,d||(Editor.log("Load worker timeout, reload worker."),e.close(),a())},1e4),d=!1,r&&e.nativeWin.webContents.on("crashed",i=>{Editor.log("Worker window crashed, reload to restart worker"),e.load(n,t)}),o&&e.openDevTools(),i&&e.nativeWin.webContents.on("did-finish-load",function(){d=!0,i(e,e.nativeWin)}),e.load(n,t)}const n="unpack://static/general-worker.html";let s,d=!1;"function"==typeof t&&(r=o,o=i,i=t,t={}),t.scriptUrl=e,a()},loadPackage(e,t){if(e.gizmos)for(let t in e.gizmos){Editor.gizmos[t]&&Editor.warn(`Override gizmos [${t}] from [${Editor.gizmos[t]}] to [${e.gizmos[t]}]`);let i=e.gizmos[t];i.startsWith("packages://")?Editor.gizmos[t]=i:Editor.gizmos[t]=`packages://${e.name}/${i}`}if(e["scene-script"]&&(Editor.sceneScripts[e.name]=`packages://${e.name}/${e["scene-script"]}`,Editor.Ipc.sendToPanel("scene","scene:load-package-scene-script",e.name,Editor.sceneScripts[e.name])),e["build-template"]&&(Editor.Builder.buildTemplates[e.name]=`packages://${e.name}/${e["build-template"]}`),e.inspector)for(let t in e.inspector)Editor.inspectors[t]=`packages://${e.name}/${e.inspector[t]}`;var i=e["runtime-resource"],o="",r=!1,a="";Async.waterfall([t=>{if(!i)return t(),void 0;o=Editor.url(`packages://${e.name}/${i.path}`),Fs.existsSync(o)&&Fs.isDirSync(o)||(Editor.warn(`Mount runtime resource failed, ${o} is not a valid folder.`),o=""),t()},t=>{if(!o)return t(),void 0;a=`${e.name}-${i.name}`,Editor.assetdb.mount(o,a,{readonly:!0},e=>{e?Editor.warn(`Mount runtime resource failed. message: ${e.stack}`):r=!0,t()})},e=>{if(!r||!Editor.assetdbInited)return e(),void 0;Editor.assetdb.attachMountPath(a,t=>{t&&Editor.warn(`Attach mount path ${a} failed. message: ${t.stack}`),e()})}],e=>{t()})},unloadPackage(e,t){if(e.gizmos)for(let t in e.gizmos)delete Editor.gizmos[t];if(e["scene-script"]&&(Editor.Ipc.sendToPanel("scene","scene:unload-package-scene-script",e.name),delete Editor.sceneScripts[e.name]),e["build-template"]&&delete Editor.Builder.buildTemplates[e.name],e.inspector)for(let t in e.inspector)delete Editor.inspectors[t];var i=e["runtime-resource"];if(!i)return t&&t(),void 0;var o=`${e.name}-${i.name}`;Async.waterfall([e=>{Editor.assetdb.unattachMountPath(o,t=>{t&&Editor.warn(`Unattach mount path ${o} failed. message: ${t.stack}`),e(t)})},t=>{Editor.assetdb.unmount(o,i=>{i&&Editor.warn(`Unmount runtime resource of package ${e.name} failed. message : ${i.stack}`),t()})}],e=>{t&&t()})}}),Editor.App.on("focus",function(){"test"!==Editor.argv._command&&Editor.assetdb.watchOFF()}),Editor.App.on("blur",function(){"test"!==Editor.argv._command&&Editor.assetdb.watchON()}),Editor.App.on("quit",function(){Editor.PreviewServer.stop(),Editor.NativeUtils.stop(),Editor._runDashboard&&process.send({channel:"show-dashboard"})});