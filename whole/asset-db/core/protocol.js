"use strict";function _uuid2path(r){let e=r.hostname;return Editor.assetdb.uuidToFspath(e)}function _url2path(r){return Editor.assetdb._fspath(r.href)}function _getRegionInfo(r){return r&&void 0!==r.x&&void 0!==r.y&&void 0!==r.w&&void 0!==r.h?{left:parseInt(r.x),top:parseInt(r.y),width:parseInt(r.w),height:parseInt(r.h)}:null}const Electron=require("electron"),protocol=Electron.protocol,Url=require("fire-url"),Fs=require("fire-fs"),QueryString=require("querystring");protocol.registerFileProtocol("uuid",(r,e)=>{let t=decodeURIComponent(r.url);e({path:_uuid2path(Url.parse(t))})},r=>{if(r)return Editor.failed(`Failed to register protocol uuid, ${r.message}`),void 0;Editor.success("protocol uuid registerred")}),Editor.Protocol.register("uuid",_uuid2path),protocol.registerFileProtocol("db",(r,e)=>{e({path:_url2path(decodeURIComponent(r.url))})},r=>{if(r)return Editor.failed(`Failed to register protocol uuid, ${r.message}`),void 0;Editor.success("protocol db registerred")}),Editor.Protocol.register("db",_url2path),protocol.registerBufferProtocol("thumbnail",(r,e)=>{let t=decodeURIComponent(r.url),o=Url.parse(t),i=_uuid2path(o);if(!Fs.existsSync(i))return e(-6),void 0;let u,s=parseInt(o.query)||32;u=Editor.dev?"sharp":Editor.url("unpack://utils/sharp");const d=require(u);var a=/\.jpg$/.test(i);a&&d.cache(!1);let l=d(i),n=QueryString.parse(o.query);if(n){let r=_getRegionInfo(n);r&&l.extract(r),n.rotate&&l.rotate(parseInt(n.rotate))}l.resize(s,s).background({r:255,g:255,b:255,alpha:0}).embed().toFormat(d.format.png).toBuffer((r,t)=>{if(a&&d.cache(!0),r)return e(-6),void 0;e({mimeType:"image/png",data:t})})},r=>{if(r)return Editor.failed(`Failed to register protocol thumbnail, ${r.message}`),void 0;Editor.success("protocol thumbnail registerred")});