"use strict";(()=>{function t(t,s){if("string"!=typeof t)return typeof t;if(s<=3||t.length<=s)return t;let i=Math.floor(s/2);return t.length>s&&t.length<s+3?t.substr(0,i)+"..."+t.substr(t.length-i+(t.length-s+3)):t.substr(0,i)+"..."+t.substr(t.length-i)}function s(s){s=s||{},this.silent=s.silent,void 0===this.silent&&(this.silent=!1),this.dev=s.dev,void 0===this.dev&&(this.dev=!1),this.metaBackupPath=s.metaBackupPath,this.assetBackupPath=s.assetBackupPath,this.cwd=s.cwd||process.cwd();let e=s.library||"library";this.library=h.resolve(this.cwd,e),r.ensureDirSync(this.library),this._mounts={},this._uuid2mtime={},this._uuid2path={},this._uuid2meta={},this._path2uuid={},this._paths=[],this._pathsDirty=!0,this._extname2infos={},this._importPath=h.join(this.library,"imports"),r.ensureDirSync(this._importPath),this._uuid2mtimePath=h.join(this.library,"uuid-to-mtime.json");try{this._uuid2mtime=JSON.parse(r.readFileSync(this._uuid2mtimePath))}catch(t){"ENOENT"!==t.code&&this.warn(`Failed to parse ${this._uuid2mtimePath}: ${t.message}.`)}this._genTaskID=-1,this._curTask=null,this._tasks=n.queue((s,e)=>{let a=s.name;s.params.length>0&&(a+=" ");for(let i=0;i<s.params.length;++i)a+=t(s.params[i],20),i!==s.params.length-1&&(a+=", ");let r=function(t){this._curTask.silent||t||this.success("done!"),this._curTask=null;try{e.apply(null,arguments)}catch(t){this.failed("Exception ",t.stack)}i&&i.Window.main&&this._tasks.idle()&&this._dispatchEvent("asset-db:state-changed","idle")}.bind(this);s.params.unshift(this),s.params.push(r),s.id=++this._genTaskID%100;try{i&&i.Window.main&&this._dispatchEvent("asset-db:state-changed","busy"),s.silent||this.log("[db-task][%s] running...",a),this._curTask=s,s.run.apply(this,s.params)}catch(t){this.failed("Exception ",t.stack),this._curTask=null,e(t),i&&i.Window.main&&this._tasks.idle()&&this._dispatchEvent("asset-db:state-changed","idle")}},1)}let i=global.Editor;if(i){const t=require("./lib/meta");i.metas||(i.metas={}),i.metas["raw-asset"]=t.RawAssetMeta,i.metas.asset=t.AssetMeta,i.metas.folder=t.FolderMeta,i.isMainProcess&&(i.versions["asset-db"]=require("./package.json").version,require("./core/protocol"))}const e=require("events"),a=require("util"),r=require("fire-fs"),h=require("fire-path"),n=require("async"),u=require("lodash");a.inherits(s,e),u.assign(s.prototype,require("./lib/utils")),u.assign(s.prototype,require("./lib/interface")),u.assign(s.prototype,require("./lib/internal")),i&&i.isMainProcess&&u.assign(s.prototype,require("./core/watch")),module.exports=s})();