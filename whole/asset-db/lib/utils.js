"use strict";const Path=require("fire-path"),Fs=require("fire-fs"),Chalk=require("chalk"),Util=require("util"),chalkSuccess=Chalk.green,chalkWarn=Chalk.yellow,chalkError=Chalk.red,chalkInfo=Chalk.cyan;let AssetDB={};module.exports=AssetDB;let _log,_success,_failed,_info,_warn,_error,ED=global.Editor;_log=console.log,_success=function(){let t=Util.format.apply(Util,arguments);console.log(chalkSuccess(t))},_info=function(){let t=Util.format.apply(Util,arguments);console.info(chalkInfo(t))},_failed=ED&&ED.failed?ED.failed:function(){let t=Util.format.apply(Util,arguments);console.log(chalkError(t))},_warn=ED&&ED.warn?ED.warn:function(){let t=Util.format.apply(Util,arguments);t=t+"\n"+new Error("dummy").stack.split("\n").splice(2).join("\n"),console.warn(chalkWarn(t))},_error=ED&&ED.error?ED.error:function(){let t=Util.format.apply(Util,arguments);t=t+"\n"+new Error("dummy").stack.split("\n").splice(2).join("\n"),console.error(chalkError(t))},ED&&ED.throw?AssetDB.throw=ED.throw:AssetDB.throw=function(t){let e=[].slice.call(arguments,1),i=Util.format.apply(Util,e);if("type"===t)throw new TypeError(i);throw new Error(i)},AssetDB.log=function(){if(this.dev&&!this.silent){if(this._curTask){let t=[].slice.call(arguments,1);return t.unshift("[db-task][%s] "+arguments[0],this._curTask.name),_log.apply(this,t),void 0}_log.apply(this,arguments)}},AssetDB.info=function(){if(this.dev&&!this.silent){if(this._curTask){let t=[].slice.call(arguments,1);return t.unshift("[db-task][%s] "+arguments[0],this._curTask.name),_info.apply(this,t),void 0}_info.apply(this,arguments)}},AssetDB.success=function(){if(this.dev&&!this.silent){if(this._curTask){let t=[].slice.call(arguments,1);return t.unshift("[db-task][%s] "+arguments[0],this._curTask.name),_success.apply(this,t),void 0}_success.apply(this,arguments)}},AssetDB.failed=function(){if(!this.silent){if(this._curTask){let t=[].slice.call(arguments,1);return t.unshift("[db-task][%s] "+arguments[0],this._curTask.name),_failed.apply(this,t),void 0}_failed.apply(this,arguments)}},AssetDB.warn=function(){if(!this.silent){if(this._curTask){let t=[].slice.call(arguments,1);return t.unshift("[db-task][%s] "+arguments[0],this._curTask.name),_warn.apply(this,t),void 0}_warn.apply(this,arguments)}},AssetDB.error=function(){if(!this.silent){if(this._curTask){let t=[].slice.call(arguments,1);return t.unshift("[db-task][%s] "+arguments[0],this._curTask.name),_error.apply(this,t),void 0}_error.apply(this,arguments)}},AssetDB.mkdirForAsset=function(t){t&&""!==t||this.throw("normal","Invalid uuid");let e=t.substring(0,2),i=Path.join(this._importPath,e);return Fs.existsSync(i)||Fs.mkdirSync(i),i},AssetDB.copyAssetToLibrary=function(t,e){let i=this._uuidToImportPathNoExt(t)+Path.extname(e);return this.mkdirForAsset(t),Fs.copySync(e,i),i},AssetDB.saveAssetToLibrary=function(t,e,i){let s;"string"==typeof e||e instanceof Buffer?s=e:(e.serialize&&(s=e.serialize()),s||(s=JSON.stringify(e,null,2))),i=i||".json";let l=this.mkdirForAsset(t);return l=Path.join(l,t+i),Fs.writeFileSync(l,s),l};let _updateMtimeDebounceID=null;AssetDB.updateMtime=function(t){if(!this.isSubAssetByUuid(t)){if(t){let e=this._uuid2path[t];if(e&&Fs.existsSync(e)){let i=Fs.statSync(e).mtime.getTime(),s=Fs.statSync(e+".meta").mtime.getTime(),l=this.getRelativePath(e);this._uuid2mtime[t]={asset:i,meta:s,relativePath:l}}else delete this._uuid2mtime[t]}_updateMtimeDebounceID&&(clearTimeout(_updateMtimeDebounceID),_updateMtimeDebounceID=null),_updateMtimeDebounceID=setTimeout(()=>{let t=JSON.stringify(this._uuid2mtime,null,2);Fs.existsSync(this.library)&&Fs.writeFileSync(this._uuid2mtimePath,t,"utf8")},50)}},AssetDB.arrayCmpFilter=function(t,e){let i=[];for(let s=0;s<t.length;++s){let l=t[s],r=!0;for(let t=0;t<i.length;++t){let s=i[t];if(l===s){r=!1;break}let n=e(s,l);if(n>0){r=!1;break}n<0&&(i.splice(t,1),--t)}r&&i.push(l)}return i},AssetDB.padLeft=function(t,e,i){return t=t.toString(),e-=t.length,e>0?new Array(e+1).join(i)+t:t};